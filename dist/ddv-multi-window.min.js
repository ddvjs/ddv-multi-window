/*!
  * ddv-multi-window v0.1.9
  * (c) 2018 yuchonghua@163.com
  * @license MIT
  */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.DdvMultiWindow={})}(this,function(t){"use strict";function i(t,e){if(!t)throw new Error("[ddv-multi-window] "+e)}var r="undefined"!=typeof window;function s(t){return void 0!==t}function d(t,e){return s(t)?t:e}function v(e,n){return Object.keys(n).forEach(function(t){e[t]=d(e[t],n[t])}),e}function o(t){return"function"==typeof t}function e(t){if(this instanceof e)return n.apply(this,arguments);throw new e(t)}function n(t){this.promises=[],this.isReadyCb=void 0,this.ing=!1}e.prototype={isReady:function(){if(!0===this.isReadyd)return Promise.resolve();return new Promise(function(t,e){this.isReadyCb=[t,e]}.bind(this))},emitReady:function(t){if(this.isReadyd=!0,!(this.isReadyCb&&Array.isArray(this.isReadyCb)&&this.isReadyCb[0]))return;t&&this.isReadyCb[1]?this.isReadyCb[1](t):this.isReadyCb[0]&&this.isReadyCb[0]()},waitReady:function(){return new Promise(function(t,e){this.promises.push([t,e]),function(){if(this.ing)return;return this.ing=!0,this.runStartTime=new Date,function t(){return this.isReady&&"function"==typeof this.isReady?this.isReady():new Promise(function(t,e){new Date-this.runStartTime>this.initCheckTimeout?e(new Error("wait Ready Timeout")):setTimeout(t,this.initCheckInterval)}.bind(this)).then(function(){return t.call(this)}.bind(this))}.call(this).then(function(t){for(var e;(e=this.promises.splice(0,1))&&(e=e&&e[0])&&"function"==typeof e[0];)e[0](t);this.ing=!1}.bind(this)).catch(function(t){for(var e;(e=this.promises.splice(0,1))&&(e=e&&e[0])&&"function"==typeof e[1];)e[1](t);this.ing=!1}.bind(this))}.call(this)}.bind(this))},setIsReady:function(t){this.isReady=t},constructor:n,isReadyd:!1,isReadyCb:void 0,initCheckTimeout:3e3,initCheckInterval:100};var a=require("jquery");function l(t,e){!s(e)&&s(t)&&(e=t,t=void 0);var n=a(e);return t?n.closest(t):n}function c(n,i){var r=[];return n.forEach(function(t,e){i(t)&&r.push.apply(r,n.splice(e,1))}),r}var u={name:"horizontal-task",props:{task:{type:Object},process:{type:Object,default:{}},handleTask:{type:Function},taskOptions:{type:Object}},computed:{taskId:function(){return this.task?this.task.id:null},activeId:function(){return this.task?this.task.activeId:null},pids:function(){return this.task?this.task.pids:[]},dragData:function(){return this.$ddvMultiWindow.dragData||{}},taskMenuStyle:function(){var e=this,n={};if(this.taskOptions.menuStyle&&"object"==typeof this.taskOptions.menuStyle){var i=Object.keys(this.taskOptions.menuStyle);i.forEach(function(t){(e.taskOptions.menuStyle[i]||0===e.taskOptions.menuStyle[i])&&(n[t]=e.taskOptions.menuStyle[i])})}return n}},data:function(){return{tabTaskLiLists:{},isLeave:!1,isShowDropdown:!1}},methods:{setInfo:function(t){var e=this,n=l(this.$refs.tabTaskWrap),i=this.pids.length;this.dragData.event=t,this.dragData.interval=[],this.dragData.$dom&&this.dragData.$dom.length?this.dragData.activeWidth=this.dragData.$dom.innerWidth()||this.dragData.activeWidth||0:this.dragData.activeWidth=this.dragData.activeWidth||0,this.dragData.marginLeft=0,this.dragData.$dom.attr("dmwDrag","1");for(var r=0,s=0;s<i;s++){var o=l('[processid="'+e.pids[s]+'"]',e.$refs.tabTask),a=Number(o.css("margin-left").split("px")[0]),d=Number(o.css("margin-right").split("px")[0]),c=o.position(),u=o.is('[dmwDrag="1"]'),h={};e.dragData.marginLeft+=a,u?r=o.innerWidth()+a-d:(h.startX=c.left+a-r,h.endX=c.left+o.innerWidth()+a-d-r,h.pid=e.pids[s],e.dragData.interval.push(h))}this.dragData.marginLeft=Math.round(this.dragData.marginLeft/i),this.dragData.barStartY=n.position().top,this.dragData.barEndY=this.dragData.barStartY+n.outerHeight()},reduction:function(){l(this.$refs.menuArrow).css("margin-left",this.dragData.marginLeft+"px"),l('[active="active"]',this.$refs.tabTask).css("margin-left",this.dragData.marginLeft+"px").removeAttr("active")},handleTabDragStart:function(t,e){var n=this.process[e],i=l(this.$refs.tabTask);this.dragData.$dom=i.closest(t.target),l(this.$refs.tabTask).addClass("transition"),this.setInfo(t),this.dragData.id=e,this.dragData.ing=!0,this.dragData.taskId=this.taskId,this.dragData.rootTaskId=this.taskId,this.dragData.isCross=!1,t.ddvCmsTaskWindowId=e,t.dataTransfer.dropEffect="move",t.dataTransfer.effectAllowed="linkMove",t.dataTransfer.setData("ddvCmsDrag",JSON.stringify({type:"tabTask",data:{windowId:e}})),t.dataTransfer.setData("text/plain",n.href||n.src)},handleTabDragEnd:function(t,e){var n=this;if(!0===this.dragData.ing)return this.dragData.ing=!1,l(this.$refs.tabTask).removeClass("transition"),this.activeEvent=null,this.dragData.id=null,this.reduction(),this.dragData.$dom.removeAttr("dmwDrag").show(),this.dragData.taskId!==this.taskId||t.pageY>=this.dragData.barStartY&&t.pageY<=this.dragData.barEndY-2?void 0:this.$ddvMultiWindow.tryRun(function(){return n.$ddvMultiWindow.openMasterWindow(e).catch(function(t){return"OPEN_WINDOW_FAIL"===t.name?n.$confirm("\u4f60\u662f\u5426\u8981\u5728\u65b0\u7a97\u53e3\u6253\u5f00","\u63d0\u793a",{confirmButtonText:"\u786e\u5b9a",cancelButtonText:"\u53d6\u6d88",type:"warning"}).then(function(){return n.$ddvMultiWindow.openMasterWindow(e)},function(t){}):Promise.reject(t)})})},handleTabWrapDragOver:function(t,e){var n=this;if(!0===this.dragData.ing){t.preventDefault();var i=l(this.$refs.tabTask),r=l(this.$refs.menuArrow);if(this.taskId!==this.dragData.taskId&&(l(this.$refs.tabTask).addClass("transition"),this.setInfo(this.dragData.event),this.dragData.isCross=this.dragData.rootTaskId!==this.taskId),this.dragData.taskId=this.taskId,t.pageY>=this.dragData.barStartY&&t.pageY<=this.dragData.barEndY-2){var s=!1;this.dragData.$dom.hide();for(var o=0;o<this.dragData.interval.length;o++){var a=n.dragData.interval[o];t.pageX>a.startX&&t.pageX<a.endX&&(s=!0,i.closest('[active="active"]').css("margin-left",n.dragData.marginLeft+"px").removeAttr("active"),l('[processid="'+a.pid+'"]',n.$refs.tabTask).css("margin-left",n.dragData.activeWidth+"px").attr("active","active"),r.css("margin-left",n.dragData.marginLeft+"px"),n.dragData.replaceId=a.pid,n.dragData.isLast=!1)}if(!s){i.closest('[active="active"]').length&&i.closest('[active="active"]').css("margin-left",this.dragData.marginLeft+"px").removeAttr("active");var d=this.dragData.interval[this.dragData.interval.length-1];d&&t.pageX>d.endX&&r.length&&r.css("margin-left",this.dragData.activeWidth+"px"),this.dragData.isLast=!0}}}},handleTabWrapDragLeave:function(t){!0===this.dragData.ing&&(t.pageY>=this.dragData.barStartY&&t.pageY<=this.dragData.barEndY-2||this.reduction())},handleTabWrapDrop:function(t,e){var n=this;if(!0===this.dragData.ing){l(this.$refs.tabTask).removeClass("transition"),t.preventDefault();var i=this.pids.indexOf(this.dragData.replaceId),r=this.pids.indexOf(this.dragData.id),s=0;if(i!==r||0===this.pids.length){if(this.dragData.isLast)s=this.pids.length-1<=-1?0:this.pids.length-1;else{var o=[];this.pids.forEach(function(t){t!==n.dragData.id&&o.push(t)}),s=o.indexOf(this.dragData.replaceId)}var a="";this.dragData.isCross?(c(this.process[this.dragData.rootTaskId].pids,function(t){return t===n.dragData.id}),a=this.dragData.id):a=this.pids.splice(r,1)[0],this.pids.splice(s,0,a),this.reduction(),this.dragData.$dom.removeAttr("dmwDrag").show(),this.$ddvMultiWindow.tabMoveMasterWindow({taskId:this.taskId,id:this.dragData.id}),this.handleTask(t,"click",this.dragData.id)}else this.reduction(),this.dragData.$dom.removeAttr("dmwDrag").show()}},pidsChange:function(){var t=this;this.$nextTick(function(){return t.tabTaskLiInit()})},tabTaskLiInit:function(){var i=this;this.pids&&Array.isArray(this.pids)&&this.pids.forEach(function(t){var e=l('[processid="'+t+'"]',i.$refs.tabTask),n=e[0];i.tabTaskLiLists[t]={dom:n,$:e,top:e.offset().top,left:e.offset().left,outerWidth:e.outerWidth(),outerHeight:e.outerHeight()}})}},watch:{pids:{deep:!0,handler:"pidsChange"}},destroyed:function(){}},h=function(){var n=this,t=n.$createElement,i=n._self._c||t;return i("div",{staticClass:"tabTask-menu tabTask"},[i("ul",{ref:"tabTaskWrap",staticClass:"tabTask-menu__ul clearfix",style:n.taskMenuStyle,on:{dragover:function(t){t.stopPropagation(),n.handleTabWrapDragOver(t,null)},dragleave:function(t){t.stopPropagation(),n.handleTabWrapDragLeave(t)},drop:function(t){t.stopPropagation(),n.handleTabWrapDrop(t,null)}}},[n._l(this.pids,function(e){return e&&n.process[e]?i("li",{key:e,ref:"tabTask",refInFor:!0,staticClass:"tabTask-menu__li",class:{"tabTask-menu__linow":e===n.activeId},attrs:{processid:e,draggable:"true"},on:{click:function(t){n.handleTask(t,"click",e)},contextmenu:function(t){n.handleTask(t,"contextMenu",e)},drop:function(t){t.stopPropagation(),n.handleTabWrapDrop(t,e)},dragstart:function(t){t.stopPropagation(),n.handleTabDragStart(t,e)},dragover:function(t){t.stopPropagation(),n.handleTabWrapDragOver(t,e)},dragend:function(t){t.stopPropagation(),n.handleTabDragEnd(t,e)}}},[i("div",{staticClass:"tabTask-menu__item"},[n._v(n._s(n.process[e].title))]),n._v(" "),i("div",{staticClass:"tabTask-menu__handle"},[i("div",{staticClass:"inline-block",on:{click:function(t){t.stopPropagation(),n.handleTask(t,"openMasterWindow",e)}}},[i("i",{staticClass:"dmw-icon icon-new-window f14"})]),n._v(" "),!1!==n.process[e].refreshable?i("div",{staticClass:"inline-block",on:{click:function(t){n.handleTask(t,"refresh",e)}}},[i("i",{staticClass:"dmw-icon icon-refresh f14"})]):n._e(),n._v(" "),!1!==n.process[e].closable?i("div",{staticClass:"inline-block",on:{click:function(t){n.handleTask(t,"remove",e)}}},[i("i",{staticClass:"dmw-icon icon-close f14"})]):n._e()])]):n._e()}),n._v(" "),i("li",{ref:"menuArrow",staticClass:"tabTask-menu__arrow",on:{mouseenter:function(t){n.isShowDropdown=!0},mouseleave:function(t){n.isShowDropdown=!1}}},[i("i",{staticClass:"dmw-icon icon-down-arrow tabTask-menu__pull f14"}),n._v(" "),i("transition",{attrs:{name:"fade"}},[i("ul",{directives:[{name:"show",rawName:"v-show",value:n.isShowDropdown,expression:"isShowDropdown"}],staticClass:"menu-dropdown"},[i("div",{staticClass:"menu-dropdown__arrow"}),n._v(" "),i("li",{staticClass:"menu-dropdown__item"},[i("div",{staticClass:"tabTask-menu__dropItem",on:{click:function(t){n.handleTask(t,"removeAll",n.task.id)}}},[i("div",{staticClass:"text-center"},[n._v("\u5173\u95ed\u5168\u90e8")])])]),n._v(" "),i("li",{staticClass:"menu-dropdown__item"},[i("div",{staticClass:"tabTask-menu__dropItem"},[i("div",{staticClass:"text-center tabTask-menu__manage"},[n._v("\u7ba1\u7406\u9ed8\u8ba4\u6807\u7b7e")])])]),n._v(" "),n.pids&&0<n.pids.length?i("li",{staticClass:"menu-dropdown__item-line"}):n._e(),n._v(" "),n._l(n.pids,function(e){return i("li",{key:e,staticClass:"menu-dropdown__item"},[i("div",{staticClass:"tabTask-menu__dropItem clearfix",on:{click:function(t){n.handleTask(t,"click",e)}}},[i("div",{staticClass:"tabTask-menu__title"},[n._v(n._s(n.process[e].title))]),n._v(" "),i("div",{staticClass:"tabTask-menu__util"},[!1!==n.process[e].closable?i("i",{staticClass:"dmw-icon icon-close f12",on:{click:function(t){n.handleTask(t,"remove",e)}}}):n._e(),n._v(" "),!1!==n.process[e].refreshable?i("i",{staticClass:"dmw-icon icon-refresh f12",on:{click:function(t){n.handleTask(t,"refresh",e)}}}):n._e()])])])})],2)])],1)],2)])};h._withStripped=!0;var p,f,m,w,y,g=(m=void 0,w=!(p={render:h,staticRenderFns:[]}),(y=("function"==typeof(f=u)?f.options:f)||{}).__file="/Users/sicmouse/Documents/GitHub/ddv-multi-window/src/components/taskComponents/horizontal-task.vue",y.render||(y.render=p.render,y.staticRenderFns=p.staticRenderFns,y._compiled=!0,w&&(y.functional=!0)),y._scopeId=m,y),k={name:"vertical-task",props:{task:{type:Object},process:{type:Object,default:{}},handleTask:{type:Function},taskOptions:{type:Object}},computed:{taskId:function(){return this.task?this.task.id:null},activeId:function(){return this.task?this.task.activeId:null},pids:function(){return this.task?this.task.pids:[]},dragData:function(){return this.$ddvMultiWindow.dragData||{}},taskMenuStyle:function(){var e=this,n={};if(this.taskOptions.menuStyle&&"object"==typeof this.taskOptions.menuStyle){var i=Object.keys(this.taskOptions.menuStyle);i.forEach(function(t){(e.taskOptions.menuStyle[i]||0===e.taskOptions.menuStyle[i])&&(n[t]=e.taskOptions.menuStyle[i])})}return n}},data:function(){return{tabTaskLiLists:{},isLeave:!1,isShowDropdown:!1}},mounted:function(){console.warn("not supported vertical mode yet")}},W=function(){var t=this.$createElement;return(this._self._c||t)("div")};W._withStripped=!0;var b,$,I,_,M,T=(I=void 0,_=!(b={render:W,staticRenderFns:[]}),(M=("function"==typeof($=k)?$.options:$)||{}).__file="/Users/sicmouse/Documents/GitHub/ddv-multi-window/src/components/taskComponents/vertical-task.vue",M.render||(M.render=b.render,M.staticRenderFns=b.staticRenderFns,M._compiled=!0,_&&(M.functional=!0)),M._scopeId=I,M),D={name:"ddv-multi-window-task-template",functional:!0,render:function(t,e){var n=e.props;return"vertical"===n.taskOptions.mode?t(T,{props:n}):t(g,{props:n})}},C={name:"ddv-multi-window-load",render:function(t){return t("section",[t("div",{},["\u52a0\u8f7d\u4e2d..."])])}};function P(t){if(Array.isArray(t))return t.map(P);if(t&&"object"==typeof t){var e={};for(var n in t)e[n]=P(t[n]);return e}return t}function O(t,e){return function e(n,i){Object.keys(i||{}).forEach(function(t){"object"==typeof n[t]?n[t]=e(n[t],i[t]):n[t]=d(n[t],i[t])});return n}(P(e),P(t))}var E=C;var R={data:function(){return{dragData:{id:null},process:{}}},computed:{ready:function(){return this.process.daemon.init},pids:function(){return Object.keys(this.process||{})||[]},taskIds:function(){var e=this;return this.pids.filter(function(t){return e.process[t]&&e.process[t].isTask})},viewIds:function(){var e=this;return this.pids.filter(function(t){return e.process[t]&&e.process[t].isHasView})},dragProcess:function(){return this.dragId&&this.process[this.dragId]||null}},created:function(){this.processPut({id:"daemon",mode:"daemon",isTask:!0,isHasView:!1,hasContentWindow:!0,contentWindow:this.$ddvMultiWindowGlobal.contentWindow}),this.$ddvMultiWindowGlobal.daemonInit(this),this.process.daemon.init=!0}};function j(e){return new Promise(function(t){return setTimeout(t,e)})}function A(t,e,n,i){if(this instanceof A)return A(t,e,n);var r=new Error(t||"Unknown Error");return r.name=e||n||r.name,r.errorId=n||r.name,i&&(r.stack=r.stack+"\n"+i),r}function S(t,e,n,i,r){if(!1===n)throw A(t,e,i,r);return Promise.reject(A(t,e,i,r))}function N(e,n,i,r){return(i=i||50)<r?(console.error(e,n),Promise.reject(new Error("\u67e5\u627e\u5931\u8d25"))):(r=(r||0)+1,e[n]?Promise.resolve(e[n]):j(60).then(function(t){return N(e,n,i,r)}))}var L=require("jquery"),x={methods:{regTask:function(t){var e=this.process[t];if(!e)throw new Error("\u6ca1\u6709\u627e\u5230\u4efb\u52a1\u680f\u7a97\u53e3");e.isTask&&Array.isArray(e.pids)||(this.$set(e,"isTask",!0),this.$set(e,"pids",[]),this.$set(e,"history",[]),this.$set(e,"activeId",null))},addTask:function(t){var e=t.taskId,n=t.id,i=this.process[e].pids;-1<i.indexOf(n)||i.push(n)},refreshTask:function(t){var n=this,i=t.taskId,r=t.id;(this.taskIds||[]).forEach(function(t){var e=n.process[t];e&&t!==i&&(e.pids=e.pids.filter(function(t){return t!==r}),e.history=e.history.filter(function(t){return t!==r}))})},windowAppendChild:function(t,e){var n,i,r=this,s=t.id,o=t.taskId,a=t.autoToTab;return 50<e?Promise.reject(new Error("\u67e5\u627e\u5931\u8d25")):(e=(e||0)+1,s&&(n=this.process[s])?n.removeing?Promise.resolve():n.$mainWrap&&n.$mainWrap[o]?(n.$mainWrap[o].append(n.$content),i=n.taskId,n.taskId=o,!1===a?Promise.resolve():this.tabToWindow(s).then(function(){return r.refreshTask({taskId:o,id:s}),r.tabToLastWindowByTaskId(i||"daemon")})):j(350).then(function(){return r.windowAppendChild({id:s,taskId:o,autoToTab:a},e)}):Promise.resolve())},viewMoveParentByPid:function(t){var e=this.process[t];e&&e.$parent&&e.$parent.length&&e.$content&&e.$content.length&&e.$parent.append(e.$content)},closeMasterWindow:function(t,e){var n=this,i=this.process[t||"daemon"];if(i&&(this.masterMoveParentByTaskId(t),!1!==e)){if(!0===e||e<=0){var r=this.process.daemon,s=i.activeId;if("master"!==i.mode)return;(i.history||[]).forEach(function(t){-1<r.history.indexOf(t)||r.history.push(t)});var o=(i.pids||[]).map(function(t){return n.addTask({taskId:"daemon",id:t}),n.windowAppendChild({taskId:"daemon",id:t,autoToTab:!1})});return i.hasContentWindow&&i.contentWindow&&!i.contentWindow.closed&&i.contentWindow.close(),Promise.all(o).then(function(){return i.pids.length=0,n.refreshTask({taskId:"daemon",id:s})})}clearTimeout(i.closeMasterTimer),i.closeMasterTimer=setTimeout(function(){n.closeMasterWindow(t,0)},e||5e3)}},closeAllMasterWindow:function(){var e=this.$ddvMultiWindowGlobal&&this.$ddvMultiWindowGlobal.map&&this.$ddvMultiWindowGlobal.map[this.daemonId]&&this.$ddvMultiWindowGlobal.map[this.daemonId].api;this.taskIds.forEach(function(t){Object.keys(e).forEach(function(t){e&&e[t]&&"function"==typeof e[t].onDaemonClose&&e[t].onDaemonClose()})})},masterMoveParentByTaskId:function(t){var e=t&&this.process[t];e&&(e.$mainParent&&e.$mainContent&&e.$mainParent.append(e.$mainContent),e.$taskParent&&e.$taskContent&&e.$taskParent.append(e.$taskContent))},masterViewInit:function(t,e,n){var i,r=this,s=this.process[e];return"view"===t?i="$mainContent":"task"===t&&(i="$taskContent"),s?(clearTimeout(s.closeMasterTimer),s[i]?s[i].length?n&&L(n).length?(n.append(s[i]),Promise.resolve()):Promise.reject(A("\u8fdb\u7a0b\u4e0d\u5b58\u5728")):Promise.reject(A("\u4efb\u52a1\u680f\u4e2d\u6ca1\u6709\u627e\u5230\u6302\u8f7d\u70b9")):N(s,i).then(function(){return r.masterViewInit(t,e,n)})):Promise.reject(A("\u8fdb\u7a0b\u4e0d\u5b58\u5728"))}}},B=0,H=0;function U(t){var e;return H!==V()&&(H=V(),B=0),e=H.toString()+(++B).toString(),t||(e=parseInt(e,10).toString(36)),e}function V(){return parseInt((new Date).getTime()/1e3)}var F,G={methods:{tryRun:function(t){var n=this;return this._dmw$tryRun(t).catch(function(e){return n.errorHooks.length?Promise.all(n.errorHooks.map(function(t){return t&&t(e)})):Promise.reject(e)})},_dmw$tryRun:function(t){if("function"==typeof t)try{var e=t();return e&&e.then?e:Promise.resolve(e)}catch(t){return Promise.reject(t)}return Promise.resolve()},createPid:function(t){return(t.mode||"child")+U()},isHasId:function(t){return-1<this.pids.indexOf(t)},checkPid:function(t,e,n){var i=this,r=0!==e;return r&&e<n?S("Window does not exist","WINDOW_NOT_EXIST",r):(n=(n||0)+1,this.isHasId(t)?r?Promise.resolve():void 0:r?j(150).then(function(){return i.checkPid(t,e,n)}):S("Window does not exist","WINDOW_NOT_EXIST",r))},getPidByWindow:function(t,e,n){var i,r,s,o=this,a=0!==e;if(e=d(e,50),a&&e<n)return S("Find pid based on window","FIND_PID_FAIL_BY_CW",a);for(i in n=(n||0)+1,o.process)if((r=o.process[i]).hasContentWindow)if(!r.contentWindow||r.contentWindow.closed)s=!0;else if(r.contentWindow===t)return a?Promise.resolve(i):i;return a&&s?a?this.dmw$handleContentWindowLoad().then(function(){return j(150)}).then(function(){return o.getPidByWindow(t,e,n)}):S("Process contentWindow not has init or closed","PROCESS_CW_NOT_INIT_OR_CLOSED",a):S("window not found","WINDOW_NOT_FINT",a)},getWindowByPid:function(t,e,n){var i=this,r=0!==e;if(e=d(e,50),r&&e<n)return S("Find window  based on pid","FIND_CW_FAIL_BY_PID",r);if(n=(n||0)+1,!t)return S("must input pid","MUST_INPUT_PID",r);var s=this.process[t];return s?s.hasContentWindow?!s.contentWindow||s.contentWindow.closed?r?this.dmw$handleContentWindowLoad().then(function(){return j(150)}).then(function(){return i.getWindowByPid(t,e,n)}):S("Process contentWindow not has init or closed","PROCESS_CW_NOT_INIT_OR_CLOSED",r):r?Promise.resolve({contentWindow:s.contentWindow}):s.contentWindow:S("Process not has contentWindow","PROCESS_NOT_CW",r):S("Process data not found","PROCESS_NOT_FIND",r)},processPut:function(t){t.id=t.id||t.pid;this.$set(this.process,t.id,v(t,{mode:null,error:null,isTask:!1,isHasTask:!0,isHasView:!0,init:!1,refinit:!1}))},routerReady:function(){var n=this;return new Promise(function(t,e){return n.$router.onReady(t,e)})}}},Y={props:{daemonId:{type:[Number,String],default:"daemon"},modeNotTasks:{type:Array,default:function(){return["daemon","master"]}},openMasterWindowSrc:{type:String,default:"/"},taskOptions:{type:Object,default:function(){return{}}},renderOptions:{type:Object,default:function(){return{root:{},daemon:{},views:{},mains:{},tasks:{},taskParent:{},taskBox:{},mainParent:{},mainBox:{style:{width:"100%",height:"100%"}},mainContent:{style:{width:"100%",height:"100%"}},viewParent:{},viewBox:{style:{width:"100%",height:"100%"}},viewLoad:{},viewError:{},viewComponent:{},viewIframe:{attrs:{frameborder:0,width:"100%",height:"100%",allowtransparency:!0}}}}}}};function q(t){if(t&&(F=t),t||"undefined"==typeof window||(F=window),!F)throw A("\u6ca1\u6709\u627e\u5230\u7a97\u53e3");return F}var X={methods:{tabToWindow:function(e){if(!this.isHasId(e))return Promise.reject(A("\u7a97\u53e3\u4e0d\u5b58\u5728"));var t=this.process[this.process[e].taskId||"daemon"];return t.activeId=e,c(t.history,function(t){return t===e}),t.history.unshift(e),Promise.resolve()},tabToLastWindowByTaskId:function(t){var e=this.process[t||"daemon"];return"daemon"===t||e.pids&&e.pids.length?e&&e.history[0]&&this.tabToWindow(e.history[0]):this.closeMasterWindow(t,0)||Promise.resolve()},tabMoveMasterWindow:function(t){var e=t.taskId,n=t.id;return this.regTask(e),this.addTask({taskId:e,id:n}),this.windowAppendChild({taskId:e,id:n})},openMasterWindow:function(t){try{var e=this.createPid({mode:"master"}),n=function(t,e,n){var i,r,s;if(!n){if("undefined"==typeof window||window.window!==window)throw A("window must input","WINDOW_MUST_INPUT");n=window}try{i=n.open(t,e.name||"",function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n+"="+t[n]);return e.join(",")}((s=n,(r=(r=e)||{}).width=r.width||640,r.height=r.height||480,r.left=r.left||s.screenX+(s.outerWidth-r.width)/2,r.top=r.top||s.screenY+(s.outerHeight-r.height)/2.5,r)))}catch(t){}if(i)return i;throw A("open window fail","OPEN_WINDOW_FAIL")}(this.openMasterWindowSrc,{name:e},this.daemonWindow||this.contentWindow);return this.processPut({id:e,mode:"master",isTask:!0,isHasView:!1,hasContentWindow:!0,contentWindow:n}),this.tabMoveMasterWindow({id:t,taskId:e})}catch(t){return Promise.reject(t)}}}};var z=/[!'()*]/g,K=function(t){return"%"+t.charCodeAt(0).toString(16)},J=/%2C/g,Q=function(t){return encodeURIComponent(t).replace(z,K).replace(J,",")};function Z(i){var t=i?Object.keys(i).map(function(e){var t=i[e];if(void 0===t)return"";if(null===t)return Q(e);if(Array.isArray(t)){var n=[];return t.forEach(function(t){void 0!==t&&(null===t?n.push(Q(e)):n.push(Q(e)+"="+Q(t)))}),n.join("&")}return Q(e)+"="+Q(t)}).filter(function(t){return 0<t.length}).join("&"):null;return t?"?"+t:""}var tt={methods:{open:function(e,t){var n=this,i={src:"/",title:"New window",closable:!0,refreshable:!0,removeing:!1,contentWindow:null,$content:null,$iframe:null,$parent:null,$mainWrap:{},hook:{beforeRefresh:[]},component:null,parentDdvMultiWindow:null,id:null},r=Object.create(null);if("string"==typeof e)r.src=e,r.options={src:e};else if("object"==typeof e){if(e.id&&-1<this.pids.indexOf(e.id)&&this.process[e.id])return this.tabToWindow(e.id).then(function(){if(!0===e.refresh)return n.refresh(e.id)}).then(function(){return n.process[e.id]});if(!e.src&&e.path){var s=e.path;e.query&&(s+=Z(e.query)),e.src=s}if(Object.keys(i).forEach(function(t){Object.hasOwnProperty.call(e,t)&&(r[t]=e[t]),r.options=e}),!r.src&&t.$process){var o=t.$process,a=o.route,d=a.path;e.query?d+=Z(e.query):d+=Z(a.query),r.src=d,!e.title&&o.title&&(r.title=o.title)}}if(r.src){var c=this.$router.getMatchedComponents(r.src);if(r.mode||(r.mode=c.length?"component":"iframe"),c.length){var u=this.$router.resolve(r.src),h=u.route,l=u.href;r.src=l,r.route=h}}else if("object"==typeof e){var p=this.$router.resolve(e),f=p.route,m=p.href;r.src=m,r.route=f}return r.taskId="object"==typeof e?e.taskId||t&&t.taskId:r.taskId||t&&t.taskId,r.mode=r.mode||"iframe",r.id||(r.id=this.createPid({mode:r.mode})),r.isHasTask=-1===this.modeNotTasks.indexOf(r.mode),r.hasContentWindow=void 0===r.hasContentWindow?-1<["iframe","daemon","master"].indexOf(r.mode):r.hasContentWindow,v(Object.assign(r,{daemonId:this.daemonId}),i),r.title=r.title||"\u65b0\u7a97\u53e3[id:"+r.id+"]",!r.isHasTask||this.process[r.taskId]&&this.process[r.taskId].isTask||(r.taskId="daemon"),r.isHasTask&&(this.regTask(r.taskId),this.addTask({taskId:r.taskId,id:r.id})),r.parentDdvMultiWindow=t||null,this.processPut(r),this.tabToWindow(r.id).then(function(){return n.process[r.id]})},remove:function(n){var i=this,t=this.process[n];return this.isHasId(n)?!1===t.closable?Promise.reject(new Error("this window cannot be closed")):(t.removeing=!0,this.viewMoveParentByPid(n),this.taskIds.forEach(function(t){var e=i.process[t];e&&(c(e.pids,function(t){return t===n}),c(e.history,function(t){return t===n}))}),this.$delete(this.process,n),this.tabToLastWindowByTaskId(t.taskId||"daemon")):Promise.reject(new Error("this window is not found"))},refresh:function(t){var e=this.process[t];if(!this.isHasId(t))return Promise.reject(new Error("this window is not found"));if(!1===e.refreshable)return Promise.reject(new Error("this window does not support refresh"));if("component"!==e.mode)return"iframe"===e.mode?this.getWindowByPid(t).then(function(t){t.contentWindow.location.reload(!0)}):Promise.reject(new Error("window does not support refresh"));if(e.component){if(Array.isArray(e.hook.beforeRefresh))for(var n=0;n<e.hook.beforeRefresh.length;n++){var i=e.hook.beforeRefresh[n];if(o(i))if(!1===i())return Promise.resolve()}e.component=null}}}},et=require("jquery");function nt(e,n){return e.push(n),function(){var t=e.indexOf(n);-1<t&&e.splice(t,1)}}var it={methods:{loadComponent:function(t){var e=this,n=this.process[t];return n&&n.isHasView?"component"!==n.mode?S("\u4e0d\u652f\u6301\u52a0\u8f7d"):(n.error=null,this.routerReady().then(function(){return e.$router.getMatchedComponents(n.src)}).then(function(t){if(!t.length){var e=new Error("404");return e.statusCode=404,Promise.reject(e)}return Promise.all(t.map(function(t){return t()}))}).then(function(t){n.component=Object.create(t[0]),n.component._ddvMultiWindow=new Pt(e,n.taskId,n),n.component.router=e.loadComponentRouter(n,n.component)}).catch(function(t){console.log("e",t),n.error=t})):S("\u4e0d\u652f\u6301\u663e\u793a")},loadComponentRouter:function(t,e){var n=Object.create(null);return Object.assign(n,rt,{daemonApp:this,$parentRouter:this.$router,process:t,options:this.$router.options}),n}}},rt={resolve:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return this.$parentRouter.resolve.apply(this.$parentRouter,t)},init:function(t){t._route=this.process.route,this.$vm=t,this.history={},this.history.current=Object.assign({},this.process.route)},push:function(e,t,n){return this.$vm.$ddvMultiWindow?this.$vm.$ddvMultiWindow.open(e):this.daemonApp.$ddvMultiWindowGlobal.get(this.process.daemonId,this.process.taskId).then(function(t){return t.open(e)})},replace:function(t,e,n){this.history.current=this.resolve(t).route}},st={name:"ddv-multi-window-daemon",mixins:[R,x,X,G,Y,tt,{methods:{dmw$iframeLoad:function(e,t){var n,i=this;return e&&(n=this.process[e])?"iframe"!==n.mode||n.removeing?Promise.resolve():Promise.resolve().then(function(){if(!n.$iframe)return N(i.$refs,"if_"+e).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,n.$iframe=et(t)})}).then(function(){if((t||!n.contentWindow||n.contentWindow.closed)&&(n.contentWindow=n.$iframe[0]&&n.$iframe[0].contentWindow||null,!n.contentWindow||n.contentWindow.closed))return j(500).then(function(t){return i.dmw$iframeLoad(e,!0)})}):Promise.resolve()},dmw$mainWrapInit:function(t){var n,i=this;return t&&(n=this.process[t])?n.removeing||!n.isHasView?Promise.resolve():Promise.all((this.taskIds||[]).map(function(e){if(n.$mainWrap||i.$set(n,"$mainWrap",{}),!n.$mainWrap[e])return N(i.$refs,"mc_"+e+"_p_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,n.$mainWrap[e]=et(t)})})):Promise.resolve()},dmw$viewInit:function(t){var e,n=this;return t&&(e=this.process[t])?e.removeing||!e.isHasView?Promise.resolve():e.refinit?this.dmw$mainWrapInit(t):Promise.resolve().then(function(){if(!e.$parent)return N(n.$refs,"vp_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$parent=et(t)})}).then(function(){if(!e.$content)return N(n.$refs,"vb_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$content=et(t)})}).then(function(){return n.dmw$mainWrapInit(t)}).then(function(){return e.refinit=!0,"iframe"===e.mode?(e.init=!0,n.dmw$iframeLoad(t)):"component"===e.mode?n.loadComponent(t).then(function(){e.init=!0}).catch(function(t){e.error=t}):void 0}).then(function(){e.init=!0}).then(function(){return n.windowAppendChild({id:t,taskId:e.taskId})}):Promise.resolve()},dmw$taskInit:function(t){var e,n=this;if(t&&(e=this.process[t])&&!e.refinit&&!e.removeing&&e.isTask)return Promise.resolve().then(function(){if(!e.$taskParent)return N(n.$refs,"tp_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$taskParent=et(t)})}).then(function(){if(!e.$taskContent)return N(n.$refs,"tb_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$taskContent=et(t)})}).then(function(){if(!e.$mainParent)return N(n.$refs,"mp_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$mainParent=et(t)})}).then(function(){if(!e.$mainContent)return N(n.$refs,"mb_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$mainContent=et(t)})}).then(function(){e.refinit=!0})},dmw$processInit:function(){var n=this,e=[];return this.pids.forEach(function(t){return e.push()}),Promise.all(this.pids.map(function(t){var e;return t&&(e=n.process[t])?e.isHasView?n.dmw$viewInit(t):e.isTask?n.dmw$taskInit(t):Promise.resolve():Promise.resolve()}))},dmw$ddvMultiWindowMapInit:function(){var e=this,n=this.$ddvMultiWindowGlobal.map[this.daemonId];return Promise.all(this.taskIds.map(function(t){n.api[t]||(n.api[t]=new Pt(n.app,t))}).concat(Object.keys(n.api||{}).map(function(t){-1<e.taskIds.indexOf(t)||e.$delete(n.api,t)})))},dmw$handleContentWindowLoad:function(){return Promise.all([this.dmw$handleMasterWindowLoad(),this.dmw$handleIframeLoad()])},dmw$handleMasterWindowLoad:function(){var n=this;return Promise.resolve(this.pids.map(function(t){if(!t||!n.process)return Promise.resolve();var e=n.process[t];return e&&e.hasContentWindow,Promise.resolve()}))},dmw$handleIframeLoad:function(t,e){var n=this;return this.tryRun(function(t){return j(300).then(function(t){return n.dmw$iframeLoad(e)})})},dmw$handlePidsChange:function(){var e=this;return this.tryRun(function(t){return Promise.all([e.dmw$processInit()])})},dmw$handleTaskIdsChange:function(){var e=this;return this.tryRun(function(t){return e.dmw$ddvMultiWindowMapInit()})},dmw$onbeforeunload:function(t){return t.returnValue="\u5173\u95ed\u4f1a\u5bfc\u81f4\u6240\u6709\u7a97\u53e3\u90fd\u5173\u95ed\uff0c\u60a8\u786e\u8ba4\u5173\u95ed","\u5173\u95ed\u4f1a\u5bfc\u81f4\u6240\u6709\u7a97\u53e3\u90fd\u5173\u95ed?"},dmw$handleCloseInit:function(){var t=this.$ddvMultiWindowGlobal.contentWindow;t.addEventListener("close",this.closeAllMasterWindow.bind(this)),t.addEventListener("unload",this.closeAllMasterWindow.bind(this)),t.addEventListener("beforeunload",this.dmw$onbeforeunload.bind(this))}},watch:{taskIds:{handler:"dmw$handleTaskIdsChange",deep:!0},pids:{handler:"dmw$handlePidsChange",deep:!0}},mounted:function(){this.dmw$handleCloseInit()}},{methods:{handleTask:function(t,e,n){var i=this;return this.$ddvMultiWindow.tryRun(function(){return i["handleTask$"+e](t,n)})},handleTask$click:function(t,e){return t.stopPropagation(),t.preventDefault(),this.$ddvMultiWindow.tabToWindow(e)},handleTask$refresh:function(t,e){return t.stopPropagation(),t.preventDefault(),this.$ddvMultiWindow.refresh(e)},handleTask$openMasterWindow:function(t,e){return t.stopPropagation(),t.preventDefault(),this.$ddvMultiWindow.openMasterWindow(e)},handleTask$remove:function(t,e){return t.stopPropagation(),t.preventDefault(),this.$ddvMultiWindow.remove(e)},handleTask$removeAll:function(t,e){var n=this;t.stopPropagation(),t.preventDefault();var i=[];return this.process[e].pids.forEach(function(t){return n.process[t]&&!1!==n.process[t].closable&&i.push(n.$ddvMultiWindow.remove(t))}),Promise.all(i)},handleTask$contextMenu:function(t,e){t.stopPropagation(),t.preventDefault(),console.log("\u53f3\u952e")}}},{methods:{onBeforeOpen:function(t){return nt(this.beforeOpenHooks,t)},onOpened:function(t){return nt(this.openedHooks,t)},onBeforeRemove:function(t){return nt(this.beforeRemoveHooks,t)},onBeforeRefres:function(t){return nt(this.beforeRefresHooks,t)},onRefreshed:function(t){return nt(this.refreshedHooks,t)},onReady:function(n,i){var r=this;return this.readyCbs.push(n),i&&this.errorHooks.push(i),function(){var t=r.readyCbs.indexOf(n),e=r.errorHooks.indexOf(i);-1<t&&r.readyCbs.splice(t,1),-1<e&&r.errorHooks.splice(e,1)}},onError:function(t){return nt(this.errorHooks,t)}},beforeCreate:function(){this.readyCbs=[],this.errorHooks=[],this.openedHooks=[],this.refreshedHooks=[],this.beforeOpenHooks=[],this.beforeRemoveHooks=[],this.beforeRefresHooks=[]}},it],render:function(t){if(this.ready){var e=this.$slots.default?Array.prototype.concat(this.$slots.default):[];return e.push(t("div",O(this.renderOptions.daemon,{key:"daemon_wrap",directives:[{name:"show",rawName:"show",value:!1}]}),[function(t){return t("div",O(this.renderOptions.mains,{key:"mains",attrs:{"ddv-multi-window-type":"mains"}}),function(i){var r=this;return this.taskIds.map(function(e){var n=r.process[e];if(n&&n.isTask)return i("div",O(r.renderOptions.mainParent,{key:e,ref:"mp_"+e,attrs:{"task-id":e,"ddv-multi-window-type":"mainParent"}}),[i("div",O(r.renderOptions.mainBox,{key:"main",ref:"mb_"+e,attrs:{"task-id":e,"ddv-multi-window-type":"mainBox"}}),(r.viewIds||[]).map(function(t){return i("div",O(r.renderOptions.mainContent,{key:t,ref:"mc_"+e+"_p_"+t,attrs:{"task-id":e,"process-id":t,"ddv-multi-window-type":"mainContent"},directives:[{name:"show",rawName:"show",value:n&&t===n.activeId}]}))}))])})}.call(this,t))}.call(this,t),function(t){return t("div",O(this.renderOptions.views,{key:"views",attrs:{"ddv-multi-window-type":"views"}}),function(i){var r=this;return this.viewIds.map(function(e){var n=r.process[e];if(n&&n.isHasView){var t=[];return n.init?n.error?t.push(i(E,O(r.renderOptions.viewError,{key:"error",attrs:{"process-id":e,"ddv-multi-window-type":"errorBox"},props:{error:r.error}}))):"component"===n.mode?n.component?t.push(i(n.component,O(r.renderOptions.viewComponent,{props:{}}))):(n.init=!1,r.loadComponent(e).then(function(){n.init=!0}).catch(function(t){n.error=t})):"iframe"===n.mode&&t.push(i("iframe",O(r.renderOptions.viewIframe,{key:"iframe",ref:"if_"+e,on:{load:function(t){return r.dmw$handleIframeLoad(t,e)}},attrs:{src:n.src,"process-id":e,"ddv-multi-window-type":"iframe"}}))):t.push(i(C,O(r.renderOptions.viewLoad,{key:"load",attrs:{"process-id":e,"ddv-multi-window-type":"loadBox"}}))),i("div",O(r.renderOptions.viewParent,{key:e,ref:"vp_"+e,attrs:{"process-id":e,"ddv-multi-window-type":"viewParent"}}),[i("div",O(r.renderOptions.viewBox,{key:"view",ref:"vb_"+e,attrs:{"process-id":e,"ddv-multi-window-type":"viewBox"}}),t)])}})}.call(this,t))}.call(this,t),function(t){return t("div",O(this.renderOptions.tasks,{key:"tasks",attrs:{"ddv-multi-window-type":"tasks"}}),function(n){var i=this;return this.taskIds.map(function(t){var e=i.process[t];if(e&&e.isTask)return n("div",O(i.renderOptions.taskParent,{key:t,ref:"tp_"+t,attrs:{"process-id":t,"ddv-multi-window-type":"taskParent"}}),[n("div",O(i.renderOptions.taskBox,{key:"task",ref:"tb_"+t,attrs:{"process-id":t,"ddv-multi-window-type":"taskBox"}}),function(t,e){var n={task:e,process:this.process,handleTask:this.handleTask,taskOptions:this.taskOptions},i=[];return this.$scopedSlots&&this.$scopedSlots.task?i.push(this.$scopedSlots.task(n)):i.push(t(D,{key:"task",attrs:{"ddv-multi-window-type":"taskContent"},props:n})),i}.call(i,n,e))])})}.call(this,t))}.call(this,t)])),t("div",O(this.renderOptions.root,{key:"root",attrs:{id:"dmw_daemon_"+this.daemonId,"ddv-multi-window-type":"root"}}),e)}}},ot={name:"ddv-multi-window-button",props:{to:{type:[String,Object]},type:{type:String,default:"open"},tag:{type:String,default:"button"},daemonId:{type:[Number,String],default:"daemon"},taskId:{type:[Number,String],default:""},event:{type:[String,Array],default:"click"},title:{type:String}},data:function(){return{ddvMultiWindowReady:!1,error:null}},render:function(t){var e=this,n={click:at};return Array.isArray(this.event)?this.event.forEach(function(t){n[t]=e.handler.bind(e)}):n[this.event]=this.handler.bind(this),t(this.tag,{on:n},this.$slots.default)},methods:{masterInit:function(){var e=this;this.$ddvMultiWindowGlobal.masterInit(this).then(function(){e.ddvMultiWindowReady=!0},function(t){console.error(t),e.error=t})},handler:function(t){var e=this;if(at(t)){var n=t.currentTarget.getAttribute("target")||this.taskId,i=O("string"==typeof this.to?{src:this.to}:P(this.to),{taskId:n});if(this.title&&(i.title=this.title),!this.ddvMultiWindowReady)return this.$ddvMultiWindowGlobal.masterInit(this).then(function(){e.comply(i)});this.comply(i)}},comply:function(t){var e=this;this.$ddvMultiWindow.tryRun(function(){switch(e.type){case"open":return e.$ddvMultiWindow.open(t);case"close":case"remove":return e.$ddvMultiWindow.remove(e.$router.process.id);default:return Promise.reject(new Error("this operation is not supported yet"))}})}},created:function(){this.$isServer||this.masterInit()}};function at(t){if(!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey||t.defaultPrevented))return t.preventDefault&&t.preventDefault(),!0}var dt={name:"ddv-multi-window-error",props:{view:{type:String,default:"view"},error:{}},render:function(t){return t("section",[t("div",{},[this.message])])},computed:{message:function(){return this.error.message||"\u51fa\u9519\u4e86"}}},ct=require("jquery"),ut=ht();function ht(t,e){return{name:t||"ddv-multi-window-master",props:{daemonId:{type:[Number,String],default:"daemon"},view:{type:String,default:e||"view"},autoColse:{type:Boolean,default:!0}},data:function(){return{ddvMultiWindowReady:!1,refReady:!1,error:null,init:!1,wrap:null,$wrap:null}},render:function(t){var e=[];return this.error?e.push(t(dt,{key:"error",attrs:{"ddv-multi-window-type":"errorBox"},props:{view:this.view,error:this.error}})):this.init||e.push(t(C,{key:"load"})),t("div",{key:"master",ref:"m",attrs:{id:"dmw_master_"+this.view+this.daemonId,"ddv-multi-window-type":"master"+this.view}},e)},methods:{masterInit:function(){var e=this;this.$ddvMultiWindowGlobal.masterInit(this).then(function(){e.$ddvMultiWindow.onDaemonClose=e.onDaemonClose.bind(e),e.ddvMultiWindowReady=!0},function(t){console.error(t),e.error=t})},refReadyInit:function(){var e=this;return Promise.resolve().then(function(){if(!e.wrap)return N(e.$refs,"m").then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.wrap=t,e.$wrap=ct(e.wrap)})}).then(function(){e.refReady=!0})},closeWindow:function(){try{this.contentWindow.close()}catch(t){try{window.close()}catch(t){}}},closeMasterWindow:function(){try{this.$ddvMultiWindow.closeMasterWindow(this.taskId,5e3)}catch(t){this.closeWindow()}},masterViewInit:function(){var t=this;if(this.masterReady){var e=this.contentWindow;e.addEventListener("close",this.closeMasterWindow.bind(this)),e.addEventListener("unload",this.closeMasterWindow.bind(this)),this.$ddvMultiWindow.masterViewInit(this.view,this.taskId,this.$wrap).then(function(){t.init=!0})}},onDaemonClose:function(){var t=this;this.$ddvMultiWindow.masterMoveParentByTaskId(this.taskId),this.error=new Error("\u4e3b\u7a97\u53e3\u88ab\u5173\u95ed"),this.autoColse&&setTimeout(function(){t.closeWindow()},1500)}},computed:{taskId:function(){return this.ddvMultiWindowReady?this.$ddvMultiWindow.taskId:null},contentWindow:function(){return this.$ddvMultiWindowGlobal.contentWindow},masterReady:function(){return this.refReady&&this.ddvMultiWindowReady}},watch:{masterReady:{handler:"masterViewInit"}},created:function(){this.$isServer||this.masterInit()},mounted:function(){this.$isServer||this.refReadyInit()}}}var lt={name:"dmw-button",functional:!0,render:function(t,e){var n=e.data,i=e.children,r=e.props;return n.props=r,t(ot,n,i)}},pt=ht("ddv-multi-window-task","task"),ft=ht("ddv-multi-window-view","view");function mt(t,e){return(t=t||this)&&t[e]?t[e]:t&&t.$parent?mt(t.$parent,e):null}var vt=kt.prototype=Object.create(null),wt=Object.create(null),yt=new kt,gt=Object.hasOwnProperty;function kt(){}Object.assign(yt,{get:function(t,e,n,i){var r=0!==n;if(!this.installed)return S("not installed. Make sure to call `Vue.use(DdvMultiWindow)`before creating root instance.","MUST_VUE_USE_DDV_MULTI_WINDOW",r);var s=this.map[t];if(!(s&&s.app&&s.api))return S("daemonId does not exist","DAEMONID_NOT_EXIST",r);if(e&&s.api[e])return r?Promise.resolve(s.api[e]):s.api[e];if("daemon"===e)return s.api.daemon=new Wt(s.app,e),r?Promise.resolve(s.api.daemon):s.api.daemon;return e=s.api.daemon.getPidByWindow(this.contentWindow,n,i),r?e.then(function(t){return t&&!s.api[t]&&(s.api[t]=new Wt(s.app,t)),Promise.resolve(s.api[t])}):(e&&!s.api[e]&&(s.api[e]=new Wt(s.app,e)),s.api[e])},isDaemon:!0,version:"0.1.9",Ready:e,install:function(t,e){if((this.installing||this.installed)&&this.$Vue===t)return;if(this.installing=!0,this.$Vue=t,this.options=e,function(t){var e=t.config.optionMergeStrategies;e.beforeDdvMultiWindowOpen=e.ddvMultiWindowOpened=e.beforeDdvMultiWindowRemove=e.ddvMultiWindowRemoved=e.beforeDdvMultiWindowRefresh=e.ddvMultiWindowRefreshed=e.created}.call(this,t),function(t){t.component(D.name,D),t.component(st.name,st),t.component(ot.name,ot),t.component(ut.name,ut),t.component(lt.name,lt),t.component(pt.name,pt),t.component(ft.name,ft)}.call(this,t),function(t){var e=this;gt.call(t.prototype,"$ddvMultiWindow")||Object.defineProperty(t.prototype,"$ddvMultiWindow",{get:function(){if(this._ddvMultiWindow||(this._ddvMultiWindow=mt(this,"_ddvMultiWindow")),this._ddvMultiWindow)return this._ddvMultiWindow;throw A("Not initialized")}}),gt.call(t.prototype,"$ddvMultiWindowGlobal")||Object.defineProperty(t.prototype,"$ddvMultiWindowGlobal",{get:function(){return e}})}.call(this,t),function(t){t.mixin({beforeCreate:function(){this._ddvMultiWindow||(this._ddvMultiWindow=this.$options._ddvMultiWindow||mt(this.$parent,"_ddvMultiWindow")),this._ddvMultiWindow&&this._ddvMultiWindow.register(this)},destroyed:function(){this._ddvMultiWindow&&this._ddvMultiWindow.unregister&&(this._ddvMultiWindow.unregister(this),delete this._ddvMultiWindow)}})}.call(this,t),t.prototype.$isServer)return this.installing=!1,void(this.installed=!0);(function(){this.options=v(this.options||{},{namespace:"__DDV_MULTI_WINDOW__"})}).call(this),function(){this.options.window||(this.options.window=void 0===typeof window?this.options.window:window);this.contentWindow=q(this.options.window),this.daemonWindow=function t(e){var n,i;e=q(e);try{n=e.location.host}catch(t){}if(!i||i===e)try{if(e.parent&&e.parent.location&&n===e.parent.location.host)try{e.parent.$ddvUtil&&e.parent.$ddvUtil.$daemonWindow&&e.parent.$ddvUtil.$daemonWindow.location&&n===e.parent.$ddvUtil.$daemonWindow.location.host&&(i=e.parent.$ddvUtil.$daemonWindow)}catch(t){}}catch(t){}if(!i||i===e)try{if(e.top&&e.top.location&&n===e.top.location.host){try{e.top.$ddvUtil&&e.top.$ddvUtil.$daemonWindow&&e.top.$ddvUtil.$daemonWindow.location&&n===e.top.$ddvUtil.$daemonWindow.location.host&&(i=e.top.$ddvUtil.$daemonWindow)}catch(t){}if(!i){i=e.top;try{e.top.opener&&e.top.opener.location&&n===e.top.opener.location.host&&(i=e.top.opener)}catch(t){}}}}catch(t){}if(!i||i===e)try{if(e.parent&&e.parent.location&&n===e.parent.location.host){i=e.parent;try{e.parent.opener&&e.parent.opener.location&&n===e.parent.opener.location.host&&(i=e.parent.opener)}catch(t){}}}catch(t){}if(!i||i===e)try{if(e.opener&&e.opener.location&&n===e.opener.location.host){try{e.opener.$ddvUtil&&e.opener.$ddvUtil.$daemonWindow&&e.opener.$ddvUtil.$daemonWindow.location&&n===e.opener.$ddvUtil.$daemonWindow.location.host&&(i=e.opener.$ddvUtil.$daemonWindow)}catch(t){}if(!i){i=e.opener;try{e.opener.opener&&e.opener.opener.location&&n===e.opener.opener.location.host&&(i=e.opener.opener)}catch(t){}}}}catch(t){}return i&&i!==e&&(i=t(i)),i||(i=e),i}(this.contentWindow),this.isDaemon=!this.contentWindow||this.contentWindow===this.daemonWindow;try{this.contentWindow&&(this.contentWindow.$ddvUtil||(this.contentWindow.$ddvUtil={}),this.contentWindow.$ddvUtil.$daemonWindow=this.daemonWindow)}catch(t){}}.call(this),function(t){t=t||this.options.namespace,this.contentWindow[t]||(this.contentWindow[t]=this)}.call(this),function(){if(this.map)return;this.contentWindow===this.daemonWindow?this.map=Object.create(null):this.daemonWindow&&this.daemonWindow[this.namespace]&&(this.map=this.daemonWindow[this.namespace].map||this.map);if(!this.map)throw A("Initialization failed, check if the 'options.namespace' is consistent with the daemon window")}.call(this),this.installing=!1,this.installed=!0},installed:!1,daemonInit:function(t){if(this.$isServer)return;var e=t.daemonId;if(!e)return S("not installed. Make sure to call `daemonInit(app)`before creating root instance.","DAEMON_NOT_INIT",!1);this.map[e]||(this.map[e]={app:t,api:{}});return t._ddvMultiWindow=this.get(e,"daemon",0)},masterInit:function(n){var e=this;if(this.$isServer)return;if(!this.installed)throw A("not installed. Make sure to call `Vue.use(DdvMultiWindow)`before creating root instance.");if(!n)throw A("\u5fc5\u987b\u4f20\u5165app\u5b9e\u4f8b");var t=n.daemonId;return this.get(t).then(function(t){try{e.contentWindow&&t&&(e.contentWindow.name=t.taskId)}catch(t){}return n._ddvMultiWindow=t},function(t){var e;return"DAEMONID_NOT_EXIST"===t.name&&(e=mt(n,"_ddvMultiWindow"))?e:Promise.reject(t)})}}),Object.assign(wt,{$isServer:function(){return this.$Vue?this.$Vue.prototype.$isServer:null},$Vue:[function(){return this._Vue?this._Vue:null},function(t){return this._Vue=t}],namespace:[function(){return this.options&&this.options.namespace},function(t){return this.options=this.options||Object.create(null),this.options.namespace=t}]}),Object.keys(wt).forEach(function(t){if(!gt.call(kt.prototype,t)){var e=wt[t];if(o(e))Object.defineProperty(vt,t,{get:e});else if(Array.isArray(e)){var n={};s(e[0])&&o(e[0])&&(n.get=e[0]),s(e[1])&&o(e[1])&&(n.set=e[1]),Object.defineProperty(vt,t,n)}}});var Wt,bt=yt.install,$t=Pt.prototype=Object.create(null),It=Object.hasOwnProperty,_t=Object.create(null),Mt="proxyDaemonApp";function Tt(t){return this.daemonApp.remove(t||this.id)}function Dt(){var t=this;return this.back().then(function(){return t.remove()})}function Ct(){var t=this;return this.backRefresh().then(function(){return t.remove()})}function Pt(){if(this instanceof Pt)return this.constructor.apply(this,arguments);throw Error("Must `new DdvMultiWindow()`")}function Ot(t){return this instanceof Ot?function(t){if(this.eventName=t.eventName||"ddvTabSysEventMessage",this.postMessageType=t.postMessageType||this.eventName+"#",this.targetOrigin=t.targetOrigin||"*",this.selfWindow=t.selfWindow||this.selfWindow,this.postEmitCallCbs={},!this.selfWindow){if("object"!=typeof window||window!==window.window)throw A("options.selfWindow must input","OPTIONS_SELFWINDOW_MUST_INPUT");this.selfWindow=window}this.selfWindow=t.selfWindow||("object"==typeof window&&window===window.window?window:this.selfWindow),this.setGetContentWindow(t.getContentWindow),o(t.onCatch)&&(this.onCatch=t.onCatch);this.onReceives={},function(t){t.addEventListener?(t.addEventListener("message",At.bind(this),!1),t.addEventListener(this.eventName,St.bind(this),!1)):t.attachEvent&&(t.attachEvent("onmessage",At.bind(this)),t.attachEvent("on"+this.eventName,St.bind(this)));try{"object"!=typeof t.onDdvMultiWindowEMCall&&(t.onDdvMultiWindowEMCall=Object.create(null)),t.onDdvMultiWindowEMCall[this.eventName]=function(t){try{this.receive(t)}catch(t){return!1}return!0}.bind(this)}catch(t){}return Promise.resolve()}.call(this,this.selfWindow),function(){this.on("postEmitCallCb",function(t){var e,n=t.data.id,i=t.data.res,r=t.data.error;r&&(r.message||r.stack)?(r.stack&&(e="@postEmitCallCb ------postEmitCallCb------\n"+r.stack),Et.call(this,n,void 0,A(r.message,r.name,r.errorId,e))):Et.call(this,n,i)}.bind(this))}.call(this)}.call(this,t):new Ot(t)}function Et(t,e,n){this.postEmitCallCbs[t]?(n?this.postEmitCallCbs[t][1](n):this.postEmitCallCbs[t][0](e),delete this.postEmitCallCbs[t]):console.debug("\u4e0d\u5b58\u5728")}function Rt(t,e,n,i,r,s){var o,a,d,c,u,h,l;if("object"!=typeof n)return l=arguments,a=Array.prototype.slice.call(l),t=e=o=i=r=s=void 0,this.getContentWindow(n).then(function(t){return a[2]=t,t=a,a=void 0,Rt.apply(this,t)}.bind(this));o=n,r=r||U();var p=JSON.stringify({id:r,type:t,data:e,isCb:s||!1});try{c=o.postMessage||void 0,h=o.targetOrigin||void 0,(u=o.contentWindow||o)&&"function"==typeof u.postMessage&&o.isPostMessage&&(c=u.postMessage.bind(u)),d="function"==typeof c}catch(t){u=o}if(h||(h=this.targetOrigin||"*"),d)try{return c(this.postMessageType+p,h,i),Promise.resolve(r)}catch(t){}if(function(t,e){var n;try{if("object"==typeof t.onDdvMultiWindowEMCall&&"function"==typeof t.onDdvMultiWindowEMCall[this.eventName])return n=this.getMessageEvent(this.eventName,{data:e}),t.onDdvMultiWindowEMCall[this.eventName](n)&&!0}catch(t){}}.call(this,u,p))return Promise.resolve(r);if(function(t,e){var n;try{n=this.getMessageEvent(this.eventName,{data:e});try{if("function"==typeof t.dispatchEvent)return t.dispatchEvent(n),!0}catch(t){}try{if("function"==typeof t.fireEvent)return t.fireEvent("on"+this.eventName,n),!0}catch(t){}}catch(t){}return!1}.call(this,u,p))return Promise.resolve(r);try{if(u&&u.postMessage&&u.postMessage!==c)return u.postMessage(this.postMessageType+p,h,i),Promise.resolve(r)}catch(t){return Promise.reject(t)}return Promise.reject(A("postMessage fail","POST_MESSAGE_FAIL"))}function jt(i){return new Promise(function(t,e){var n=i(this.event);o(n.then)?(this.isCb=!0,n.then(t,e)):n?(this.isCb=!0,t(n)):t(),t=e=void 0}.bind(this)).then(function(t){return this.isCb&&this.event&&this.event.id&&this.postEmit("postEmitCallCb",{id:this.event.id,res:t},{contentWindow:this.event.source})}.bind(this),function(t){return this.isCb&&this.event&&this.event.id&&this.postEmit("postEmitCallCb",{id:this.event.id,error:{name:t.name||void 0,stack:t.stack||void 0,message:t.message||void 0,errorId:t.errorId||void 0}},{contentWindow:this.event.source})}.bind(this))}function At(t){var e=t.data||void 0;if("string"==typeof e&&e.substr(0,this.postMessageType.length)===this.postMessageType)return this.receive(t,e.substr(this.postMessageType.length))}function St(t){return this.receive(t)}Wt=Pt,Object.assign($t,{constructor:function(t,e,n){i(yt.installed,"not installed. Make sure to call `Vue.use(DdvMultiWindow)` before creating root instance."),i(r,"\u5fc5\u987b\u6709\u4e00\u4e2awindow"),this._vueModels=[],this._daemonApp=t,this._initTaskId=e,this._process=n||null},register:function(t){Array.isArray(this._vueModels)&&this._vueModels.push(t),this.process&&t&&t.$options.beforeDdvMultiWindowRefresh&&t.$options.beforeDdvMultiWindowRefresh.length&&this.process.hook.beforeRefresh.push.apply(this.process.hook.beforeRefresh,t.$options.beforeDdvMultiWindowRefresh)},unregister:function(e){this.process&&this.process.hook&&e&&e.$options&&e.$options.beforeDdvMultiWindowRefresh&&(this.process.hook.beforeRefresh=this.process.hook.beforeRefresh.filter(function(t){return e.$options.beforeDdvMultiWindowRefresh.indexOf(t)<0}));Array.isArray(this._vueModels)&&(this._vueModels=this._vueModels.filter(function(t){return e!==t}),this._vueModels.length||this.destroy())},open:function(t){return this.daemonApp.open(t,this)},remove:Tt,refresh:function(t){return this.daemonApp.refresh(t||this.id)},close:Tt,destroy:function(){delete this._vueModels,delete this._daemonApp,delete this._initTaskId,delete this._process},back:function(){return this.parent&&this.tabToWindow(this.parent.id)},backRefresh:function(){var t=this;return this.back().then(function(){return t.refresh(t.parent.id)})},removeBack:Dt,removeBackRefresh:Ct,closeBack:Dt,closeBackRefresh:Ct}),Object.assign(_t,{tryRun:Mt,onError:Mt,dragData:Mt,dragProcess:Mt,masterViewInit:Mt,tabToWindow:Mt,getPidByWindow:Mt,getWindowByPid:Mt,openMasterWindow:Mt,windowAppendChild:Mt,tabMoveMasterWindow:Mt,closeMasterWindow:Mt,masterMoveParentByTaskId:Mt,systemProcess:function(){return this.daemonApp.process},process:function(){return this._process?this._process:null},id:function(){return this.process?this.process.id:null},parent:function(){return this.process&&this.process.parentDdvMultiWindow?this.process.parentDdvMultiWindow:null},taskId:function(){return this.process?this.process.taskId:this._initTaskId?this._initTaskId:null},daemonId:Mt,daemonApp:function(){return this._daemonApp?this._daemonApp:null}}),Object.keys(_t).forEach(function(e){if(!It.call($t,e)){var t=_t[e];if(t===Mt)Object.defineProperty($t,e,{get:function(){return i(this.daemonApp,"\u591a\u7a97\u53e3\u6ca1\u6709\u521d\u59cb\u5316"),this.daemonApp[e]},set:function(t){return i(this.daemonApp,"\u591a\u7a97\u53e3\u6ca1\u6709\u521d\u59cb\u5316"),this.daemonApp[e]=t}});else if(o(t))Object.defineProperty($t,e,{get:t});else if(Array.isArray(t)){var n={};s(t[0])&&o(t[0])&&(n.get=t[0]),s(t[1])&&o(t[1])&&(n.set=t[1]),Object.defineProperty($t,e,n)}}}),Object.assign(Ot.prototype,{eventName:"ddvTabSysEventMessage",targetOrigin:"*"},{on:function(t,e){Array.isArray(this.onReceives[t])||(this.onReceives[t]=[]);this.onReceives[t].push(e)},emit:function(t){var e;if(!t.type)return(e=A("Message type error","MESSAGE_TYPE_ERROR")).isDecodeError=!0,Promise.reject(e);for(var n=this.onReceives[t.type]||[],i=0;i<n.length;i++)jt.call({isCb:!1,event:t,postEmit:Rt.bind(this)},n[i]);t=void 0},remove:function(t,e){var n=this;if("function"==typeof t)for(var i in e=t,n.onReceives)n.onReceives.hasOwnProperty(i)&&n.remove(i,e);else if("string"==typeof t)if("function"==typeof e)for(var r=0;r<this.onReceives[t].length;r++)Array.isArray(n.onReceives[t])&&n.onReceives[t][r]===e&&(n.onReceives[t].splice(r,1),r--);else delete this.onReceives[t]},destroy:function(){},onCatch:function(t){return Promise.reject(t)},receive:function(n,t){return this.decodeMessage(t||n.data||void 0).then(function(t){var e=this.getMessageEvent(t.type,Object.assign(Object.create(null),{source:n.source,origin:n.origin},t));return this.emit(e)}.bind(this),function(t){return t.isDecodeError=!0,this.onCatch(t)}.bind(this))},postEmit:Rt,postEmitCall:function(t,r,s,o){return new Promise(function(e,n){var i=U();this.postEmitCallCbs[i]=[e,n],this.postEmit(t,r,s,o,i,!0).then(function(){i=e=n=void 0},function(t){Et.call(this,i,void 0,t),i=e=n=t=void 0}.bind(this))}.bind(this))},decodeMessage:function(t){var e;if("string"!=typeof t)return Promise.reject(A("Input must be a string","INPUT_MUST_STRING"));try{e=JSON.parse(t)}catch(t){return Promise.reject(A("window not found","WINDOW_NOT_FINT"))}return Promise.resolve(e)},getMessageEvent:function(t,e){var n;(e="object"==typeof e?e:Object.create(null)).source=e.source||this.selfWindow,e.origin=e.origin||this.selfWindow.origin||this.selfWindow.location&&this.selfWindow.location.origin;try{n="function"==typeof MessageEvent?new MessageEvent(t,e):new Event(t,e)}catch(t){n=e}return"source origin ports data id isCb".split(" ").forEach(function(t){try{e[t]&&n[t]!==e[t]&&(n[t]=e[t])}catch(t){}}),n},setGetContentWindow:function(t){o(t)?this.getContentWindow=t:this.getContentWindow=function(){return Promise.resolve({contentWindow:window})}}}),r&&window.Vue&&window.Vue.use(Pt),t.Ready=e,t.install=bt,t.default=yt,t.EventMessageWindow=Ot,Object.defineProperty(t,"__esModule",{value:!0})});