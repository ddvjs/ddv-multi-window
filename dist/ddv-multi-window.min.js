/*!
  * ddv-multi-window v0.1.4
  * (c) 2018 yuchonghua@163.com
  * @license MIT
  */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.DdvMultiWindow={})}(this,function(t){"use strict";function n(t,e){if(!t)throw new Error("[ddv-multi-window] "+e)}var e="undefined"!=typeof window;function s(t,e){this.constructor(t,e)}function i(t){if(this instanceof i)return o.apply(this,arguments);throw new i(t)}function o(t){this.promises=[],this.isReadyCb=void 0,this.ing=!1}function f(t,e,n,i){if(this instanceof f)return f(t,e,n);var o=new Error(t||"Unknown Error");return o.name=e||n||o.name,o.errorId=n||o.name,i&&(o.stack=o.stack+"\n"+i),o}function d(t,e,n,i,o){if(!1===n)throw f(t,e,i,o);return Promise.reject(f(t,e,i,o))}s.prototype={constructor:function(t,e){this.app=t,this.taskId=e},open:function(t){return this.app.open(t,this.taskId)}},["id","open","remove","refresh","tryRun","process","onError","dragData","dragProcess","masterViewInit","tabToWindow","getPidByWindow","getWindowByPid","openMasterWindow","windowAppendChild","tabMoveMasterWindow","closeMasterWindow","masterMoveParentByTaskId"].forEach(function(e){s.prototype.hasOwnProperty(e)||Object.defineProperty(s.prototype,e,{get:function(){return n(this.app,"\u591a\u7a97\u53e3\u6ca1\u6709\u521d\u59cb\u5316"),this.app[e]},set:function(t){return n(this.app,"\u591a\u7a97\u53e3\u6ca1\u6709\u521d\u59cb\u5316"),this.app[e]=t}})}),i.prototype={isReady:function(){if(!0===this.isReadyd)return Promise.resolve();return new Promise(function(t,e){this.isReadyCb=[t,e]}.bind(this))},emitReady:function(t){if(this.isReadyd=!0,!(this.isReadyCb&&Array.isArray(this.isReadyCb)&&this.isReadyCb[0]))return;t&&this.isReadyCb[1]?this.isReadyCb[1](t):this.isReadyCb[0]&&this.isReadyCb[0]()},waitReady:function(){return new Promise(function(t,e){this.promises.push([t,e]),function(){if(this.ing)return;return this.ing=!0,this.runStartTime=new Date,function t(){return this.isReady&&"function"==typeof this.isReady?this.isReady():new Promise(function(t,e){new Date-this.runStartTime>this.initCheckTimeout?e(new Error("wait Ready Timeout")):setTimeout(t,this.initCheckInterval)}.bind(this)).then(function(){return t.call(this)}.bind(this))}.call(this).then(function(t){for(var e;(e=this.promises.splice(0,1))&&(e=e&&e[0])&&"function"==typeof e[0];)e[0](t);this.ing=!1}.bind(this)).catch(function(t){for(var e;(e=this.promises.splice(0,1))&&(e=e&&e[0])&&"function"==typeof e[1];)e[1](t);this.ing=!1}.bind(this))}.call(this)}.bind(this))},setIsReady:function(t){this.isReady=t},constructor:o,isReadyd:!1,isReadyCb:void 0,initCheckTimeout:3e3,initCheckInterval:100};var r=0,a=0;function m(t){var e;return a!==c()&&(a=c(),r=0),e=a.toString()+(++r).toString(),t||(e=parseInt(e,10).toString(36)),e}function c(){return parseInt((new Date).getTime()/1e3)}function h(t){return"function"==typeof t}function u(t){return this instanceof u?function(t){if(this.eventName=t.eventName||"ddvTabSysEventMessage",this.postMessageType=t.postMessageType||this.eventName+"#",this.targetOrigin=t.targetOrigin||"*",this.selfWindow=t.selfWindow||this.selfWindow,this.postEmitCallCbs={},!this.selfWindow){if("object"!=typeof window||window!==window.window)throw f("options.selfWindow must input","OPTIONS_SELFWINDOW_MUST_INPUT");this.selfWindow=window}this.selfWindow=t.selfWindow||("object"==typeof window&&window===window.window?window:this.selfWindow),this.setGetContentWindow(t.getContentWindow),h(t.onCatch)&&(this.onCatch=t.onCatch);this.onReceives={},function(t){t.addEventListener?(t.addEventListener("message",w.bind(this),!1),t.addEventListener(this.eventName,y.bind(this),!1)):t.attachEvent&&(t.attachEvent("onmessage",w.bind(this)),t.attachEvent("on"+this.eventName,y.bind(this)));try{"object"!=typeof t.onDdvMultiWindowEMCall&&(t.onDdvMultiWindowEMCall=Object.create(null)),t.onDdvMultiWindowEMCall[this.eventName]=function(t){try{this.receive(t)}catch(t){return!1}return!0}.bind(this)}catch(t){}return Promise.resolve()}.call(this,this.selfWindow),function(){this.on("postEmitCallCb",function(t){var e,n=t.data.id,i=t.data.res,o=t.data.error;o&&(o.message||o.stack)?(o.stack&&(e="@postEmitCallCb ------postEmitCallCb------\n"+o.stack),l.call(this,n,void 0,f(o.message,o.name,o.errorId,e))):l.call(this,n,i)}.bind(this))}.call(this)}.call(this,t):new u(t)}function l(t,e,n){this.postEmitCallCbs[t]?(n?this.postEmitCallCbs[t][1](n):this.postEmitCallCbs[t][0](e),delete this.postEmitCallCbs[t]):console.debug("\u4e0d\u5b58\u5728")}function v(t,e,n,i,o,r){var s,a,d,c,h,u,l;if("object"!=typeof n)return l=arguments,a=Array.prototype.slice.call(l),t=e=s=i=o=r=void 0,this.getContentWindow(n).then(function(t){return a[2]=t,t=a,a=void 0,v.apply(this,t)}.bind(this));s=n,o=o||m();var p=JSON.stringify({id:o,type:t,data:e,isCb:r||!1});try{c=s.postMessage||void 0,u=s.targetOrigin||void 0,(h=s.contentWindow||s)&&"function"==typeof h.postMessage&&s.isPostMessage&&(c=h.postMessage.bind(h)),d="function"==typeof c}catch(t){h=s}if(u||(u=this.targetOrigin||"*"),d)try{return c(this.postMessageType+p,u,i),Promise.resolve(o)}catch(t){}if(function(t,e){var n;try{if("object"==typeof t.onDdvMultiWindowEMCall&&"function"==typeof t.onDdvMultiWindowEMCall[this.eventName])return n=this.getMessageEvent(this.eventName,{data:e}),t.onDdvMultiWindowEMCall[this.eventName](n)&&!0}catch(t){}}.call(this,h,p))return Promise.resolve(o);if(function(t,e){var n;try{n=this.getMessageEvent(this.eventName,{data:e});try{if("function"==typeof t.dispatchEvent)return t.dispatchEvent(n),!0}catch(t){}try{if("function"==typeof t.fireEvent)return t.fireEvent("on"+this.eventName,n),!0}catch(t){}}catch(t){}return!1}.call(this,h,p))return Promise.resolve(o);try{if(h&&h.postMessage&&h.postMessage!==c)return h.postMessage(this.postMessageType+p,u,i),Promise.resolve(o)}catch(t){return Promise.reject(t)}return Promise.reject(f("postMessage fail","POST_MESSAGE_FAIL"))}function p(i){return new Promise(function(t,e){var n=i(this.event);h(n.then)?(this.isCb=!0,n.then(t,e)):n?(this.isCb=!0,t(n)):t(),t=e=void 0}.bind(this)).then(function(t){return this.isCb&&this.event&&this.event.id&&this.postEmit("postEmitCallCb",{id:this.event.id,res:t},{contentWindow:this.event.source})}.bind(this),function(t){return this.isCb&&this.event&&this.event.id&&this.postEmit("postEmitCallCb",{id:this.event.id,error:{name:t.name||void 0,stack:t.stack||void 0,message:t.message||void 0,errorId:t.errorId||void 0}},{contentWindow:this.event.source})}.bind(this))}function w(t){var e=t.data||void 0;if("string"==typeof e&&e.substr(0,this.postMessageType.length)===this.postMessageType)return this.receive(t,e.substr(this.postMessageType.length))}function y(t){return this.receive(t)}function g(t){return void 0!==t}function W(t,e){return g(t)?t:e}function k(e,n){return Object.keys(n).forEach(function(t){e[t]=W(e[t],n[t])}),e}Object.assign(u.prototype,{eventName:"ddvTabSysEventMessage",targetOrigin:"*"},{on:function(t,e){Array.isArray(this.onReceives[t])||(this.onReceives[t]=[]);this.onReceives[t].push(e)},emit:function(t){var e;if(!t.type)return(e=f("Message type error","MESSAGE_TYPE_ERROR")).isDecodeError=!0,Promise.reject(e);for(var n=this.onReceives[t.type]||[],i=0;i<n.length;i++)p.call({isCb:!1,event:t,postEmit:v.bind(this)},n[i]);t=void 0},remove:function(t,e){var n=this;if("function"==typeof t)for(var i in e=t,n.onReceives)n.onReceives.hasOwnProperty(i)&&n.remove(i,e);else if("string"==typeof t)if("function"==typeof e)for(var o=0;o<this.onReceives[t].length;o++)Array.isArray(n.onReceives[t])&&n.onReceives[t][o]===e&&(n.onReceives[t].splice(o,1),o--);else delete this.onReceives[t]},destroy:function(){},onCatch:function(t){return Promise.reject(t)},receive:function(n,t){return this.decodeMessage(t||n.data||void 0).then(function(t){var e=this.getMessageEvent(t.type,Object.assign(Object.create(null),{source:n.source,origin:n.origin},t));return this.emit(e)}.bind(this),function(t){return t.isDecodeError=!0,this.onCatch(t)}.bind(this))},postEmit:v,postEmitCall:function(t,o,r,s){return new Promise(function(e,n){var i=m();this.postEmitCallCbs[i]=[e,n],this.postEmit(t,o,r,s,i,!0).then(function(){i=e=n=void 0},function(t){l.call(this,i,void 0,t),i=e=n=t=void 0}.bind(this))}.bind(this))},decodeMessage:function(t){var e;if("string"!=typeof t)return Promise.reject(f("Input must be a string","INPUT_MUST_STRING"));try{e=JSON.parse(t)}catch(t){return Promise.reject(f("window not found","WINDOW_NOT_FINT"))}return Promise.resolve(e)},getMessageEvent:function(t,e){var n;(e="object"==typeof e?e:Object.create(null)).source=e.source||this.selfWindow,e.origin=e.origin||this.selfWindow.origin||this.selfWindow.location&&this.selfWindow.location.origin;try{n="function"==typeof MessageEvent?new MessageEvent(t,e):new Event(t,e)}catch(t){n=e}return"source origin ports data id isCb".split(" ").forEach(function(t){try{e[t]&&n[t]!==e[t]&&(n[t]=e[t])}catch(t){}}),n},setGetContentWindow:function(t){h(t)?this.getContentWindow=t:this.getContentWindow=function(){return Promise.resolve({contentWindow:window})}}});var b=require("jquery");function $(t,e){!g(e)&&g(t)&&(e=t,t=void 0);var n=b(e);return t?n.closest(t):n}function I(n,i){var o=[];return n.forEach(function(t,e){i(t)&&o.push.apply(o,n.splice(e,1))}),o}var P={name:"ddv-multi-window-task-template",props:{task:{type:Object},process:{type:Object,default:{}},handleTask:{type:Function}},computed:{taskId:function(){return this.task?this.task.id:null},activeId:function(){return this.task?this.task.activeId:null},pids:function(){return this.task?this.task.pids:[]},dragData:function(){return this.$ddvMultiWindow.dragData||{}}},data:function(){return{tabTaskLiLists:{},isLeave:!1,isShowDropdown:!1}},methods:{setInfo:function(t){var e=this,n=$(this.$refs.tabTaskWrap),i=this.pids.length;this.dragData.event=t,this.dragData.interval=[],this.dragData.$dom&&this.dragData.$dom.length?this.dragData.activeWidth=this.dragData.$dom.innerWidth()||this.dragData.activeWidth||0:this.dragData.activeWidth=this.dragData.activeWidth||0,this.dragData.marginLeft=0,this.dragData.$dom.attr("dmwDrag","1");for(var o=0,r=0;r<i;r++){var s=$('[processid="'+e.pids[r]+'"]',e.$refs.tabTask),a=Number(s.css("margin-left").split("px")[0]),d=Number(s.css("margin-right").split("px")[0]),c=s.position(),h=s.is('[dmwDrag="1"]'),u={};e.dragData.marginLeft+=a,h?o=s.innerWidth()+a-d:(u.startX=c.left+a-o,u.endX=c.left+s.innerWidth()+a-d-o,u.pid=e.pids[r],e.dragData.interval.push(u))}this.dragData.marginLeft=Math.round(this.dragData.marginLeft/i),this.dragData.barStartY=n.position().top,this.dragData.barEndY=this.dragData.barStartY+n.outerHeight()},reduction:function(){$(this.$refs.menuArrow).css("margin-left",this.dragData.marginLeft+"px"),$('[active="active"]',this.$refs.tabTask).css("margin-left",this.dragData.marginLeft+"px").removeAttr("active")},handleTabDragStart:function(t,e){var n=$(this.$refs.tabTask);this.dragData.$dom=n.closest(t.target),$(this.$refs.tabTask).addClass("transition"),this.setInfo(t),this.dragData.id=e,this.dragData.taskId=this.taskId,this.dragData.rootTaskId=this.taskId,this.dragData.isCross=!1,t.ddvCmsTaskWindowId=e,t.dataTransfer.dropEffect="move",t.dataTransfer.effectAllowed="linkMove",t.dataTransfer.setData("ddvCmsDrag",JSON.stringify({type:"tabTask",data:{windowId:e}})),t.dataTransfer.setData("text/plain","http://www.baidu.com/sfa/ss")},handleTabDragEnd:function(t,e){var n=this;if($(this.$refs.tabTask).removeClass("transition"),this.activeEvent=null,this.dragData.id=null,this.reduction(),this.dragData.$dom.removeAttr("dmwDrag").show(),this.dragData.taskId===this.taskId&&!(t.pageY>=this.dragData.barStartY&&t.pageY<=this.dragData.barEndY-2))return this.$ddvMultiWindow.tryRun(function(){return n.$ddvMultiWindow.openMasterWindow(e).catch(function(t){return"OPEN_WINDOW_FAIL"===t.name?n.$confirm("\u4f60\u662f\u5426\u8981\u5728\u65b0\u7a97\u53e3\u6253\u5f00","\u63d0\u793a",{confirmButtonText:"\u786e\u5b9a",cancelButtonText:"\u53d6\u6d88",type:"warning"}).then(function(){return n.$ddvMultiWindow.openMasterWindow(e)},function(t){}):Promise.reject(t)})})},handleTabWrapDragOver:function(t,e){var n=this;t.preventDefault();var i=$(this.$refs.tabTask),o=$(this.$refs.menuArrow);if(this.taskId!==this.dragData.taskId&&($(this.$refs.tabTask).addClass("transition"),this.setInfo(this.dragData.event),this.dragData.isCross=this.dragData.rootTaskId!==this.taskId),this.dragData.taskId=this.taskId,t.pageY>=this.dragData.barStartY&&t.pageY<=this.dragData.barEndY-2){var r=!1;this.dragData.$dom.hide();for(var s=0;s<this.dragData.interval.length;s++){var a=n.dragData.interval[s];t.pageX>a.startX&&t.pageX<a.endX&&(r=!0,i.closest('[active="active"]').css("margin-left",n.dragData.marginLeft+"px").removeAttr("active"),$('[processid="'+a.pid+'"]',n.$refs.tabTask).css("margin-left",n.dragData.activeWidth+"px").attr("active","active"),o.css("margin-left",n.dragData.marginLeft+"px"),n.dragData.replaceId=a.pid,n.dragData.isLast=!1)}if(!r){i.closest('[active="active"]').length&&i.closest('[active="active"]').css("margin-left",this.dragData.marginLeft+"px").removeAttr("active");var d=this.dragData.interval[this.dragData.interval.length-1];d&&t.pageX>d.endX&&o.length&&o.css("margin-left",this.dragData.activeWidth+"px"),this.dragData.isLast=!0}}},handleTabWrapDragLeave:function(t){t.pageY>=this.dragData.barStartY&&t.pageY<=this.dragData.barEndY-2||this.reduction()},handleTabWrapDrop:function(t,e){var n=this;$(this.$refs.tabTask).removeClass("transition"),t.preventDefault();var i=this.pids.indexOf(this.dragData.replaceId),o=this.pids.indexOf(this.dragData.id),r=0;if(i!==o||0===this.pids.length){if(this.dragData.isLast)r=this.pids.length-1<=-1?0:this.pids.length-1;else{var s=[];this.pids.forEach(function(t){t!==n.dragData.id&&s.push(t)}),r=s.indexOf(this.dragData.replaceId)}var a="";this.dragData.isCross?(I(this.process[this.dragData.rootTaskId].pids,function(t){return t===n.dragData.id}),a=this.dragData.id):a=this.pids.splice(o,1)[0],this.pids.splice(r,0,a),this.reduction(),this.dragData.$dom.removeAttr("dmwDrag").show(),this.$ddvMultiWindow.tabMoveMasterWindow({taskId:this.taskId,id:this.dragData.id}),this.handleTask(t,"click",this.dragData.id)}else this.reduction(),this.dragData.$dom.removeAttr("dmwDrag").show()},pidsChange:function(){var t=this;this.$nextTick(function(){return t.tabTaskLiInit()})},tabTaskLiInit:function(){var i=this;this.pids&&Array.isArray(this.pids)&&this.pids.forEach(function(t){var e=$('[processid="'+t+'"]',i.$refs.tabTask),n=e[0];i.tabTaskLiLists[t]={dom:n,$:e,top:e.offset().top,left:e.offset().left,outerWidth:e.outerWidth(),outerHeight:e.outerHeight()}})}},watch:{pids:{deep:!0,handler:"pidsChange"}},destroyed:function(){},mounted:function(){}},_=function(){var i=this,t=i.$createElement,o=i._self._c||t;return o("section",[o("div",{staticClass:"tabTask-menu"},[o("ul",{ref:"tabTaskWrap",staticClass:"tabTask-menu__ul clearfix",on:{dragover:function(t){return t.stopPropagation(),e=t,i.handleTabWrapDragOver(e,null);var e},dragleave:function(t){return t.stopPropagation(),e=t,i.handleTabWrapDragLeave(e);var e},drop:function(t){return t.stopPropagation(),e=t,i.handleTabWrapDrop(e,null);var e}}},[i._l(this.pids,function(n){return n&&i.process[n]?o("li",{key:n,ref:"tabTask",refInFor:!0,class:{"tabTask-menu__li":1,"tabTask-menu__linow":n===i.activeId},attrs:{processid:n,draggable:"true"},on:{click:function(t){return i.handleTask(t,"click",n)},contextmenu:function(t){return i.handleTask(t,"contextMenu",n)},drop:function(t){return t.stopPropagation(),e=t,i.handleTabWrapDrop(e,n);var e},dragstart:function(t){return t.stopPropagation(),e=t,i.handleTabDragStart(e,n);var e},dragover:function(t){return t.stopPropagation(),e=t,i.handleTabWrapDragOver(e,n);var e},dragend:function(t){return t.stopPropagation(),e=t,i.handleTabDragEnd(e,n);var e}}},[o("div",{staticClass:"tabTask-menu__item"},[i._v(i._s(i.process[n].title))]),i._v(" "),o("div",{staticClass:"tabTask-menu__handle"},[o("div",{staticClass:"inline-block",on:{click:function(t){t.stopPropagation(),i.handleTask(t,"openMasterWindow",n)}}},[o("i",{staticClass:"dmw-icon icon-new-window f14"})]),i._v(" "),!1!==i.process[n].refreshable?o("div",{staticClass:"inline-block",on:{click:function(t){i.handleTask(t,"refresh",n)}}},[o("i",{staticClass:"dmw-icon icon-refresh f14"})]):i._e(),i._v(" "),!1!==i.process[n].closable?o("div",{staticClass:"inline-block",on:{click:function(t){i.handleTask(t,"remove",n)}}},[o("i",{staticClass:"dmw-icon icon-close f14"})]):i._e()])]):i._e()}),i._v(" "),o("li",{ref:"menuArrow",staticClass:"tabTask-menu__arrow",on:{mouseenter:function(t){i.isShowDropdown=!0},mouseleave:function(t){i.isShowDropdown=!1}}},[o("i",{staticClass:"dmw-icon icon-down-arrow tabTask-menu__pull f14"}),i._v(" "),o("transition",{attrs:{name:"fade"}},[o("ul",{directives:[{name:"show",rawName:"v-show",value:i.isShowDropdown,expression:"isShowDropdown"}],staticClass:"menu-dropdown"},[o("div",{staticClass:"menu-dropdown__arrow"}),i._v(" "),o("li",{staticClass:"menu-dropdown__item"},[o("div",{staticClass:"tabTask-menu__dropItem",on:{click:function(t){i.handleTask(t,"removeAll",i.task.id)}}},[o("div",{staticClass:"text-center"},[i._v("\u5173\u95ed\u5168\u90e8")])])]),i._v(" "),o("li",{staticClass:"menu-dropdown__item"},[o("div",{staticClass:"tabTask-menu__dropItem"},[o("div",{staticClass:"text-center tabTask-menu__manage"},[i._v("\u7ba1\u7406\u9ed8\u8ba4\u6807\u7b7e")])])]),i._v(" "),i.pids&&0<i.pids.length?o("li",{staticClass:"menu-dropdown__item-line"}):i._e(),i._v(" "),i._l(i.pids,function(e){return o("li",{key:e,staticClass:"menu-dropdown__item"},[o("div",{staticClass:"tabTask-menu__dropItem clearfix",on:{click:function(t){i.handleTask(t,"click",e)}}},[o("div",{staticClass:"tabTask-menu__title"},[i._v(i._s(i.process[e].title))]),i._v(" "),o("div",{staticClass:"tabTask-menu__util"},[!1!==i.process[e].closable?o("i",{staticClass:"dmw-icon icon-close f12",on:{click:function(t){i.handleTask(t,"remove",e)}}}):i._e(),i._v(" "),!1!==i.process[e].refreshable?o("i",{staticClass:"dmw-icon icon-refresh f12",on:{click:function(t){i.handleTask(t,"refresh",e)}}}):i._e()])])])})],2)])],1)],2)])])};_._withStripped=!0;var T,M,C,D,O,E=(C=void 0,D=!(T={render:_,staticRenderFns:[]}),(O=("function"==typeof(M=P)?M.options:M)||{}).__file="/Users/sicmouse/Documents/GitHub/ddv-multi-window/src/components/task.vue",O.render||(O.render=T.render,O.staticRenderFns=T.staticRenderFns,O._compiled=!0,D&&(O.functional=!0)),O._scopeId=C,O),R={name:"ddv-multi-window-load",render:function(t){return t("section",[t("div",{},["\u52a0\u8f7d\u4e2d..."])])}};function S(t){if(Array.isArray(t))return t.map(S);if(t&&"object"==typeof t){var e={};for(var n in t)e[n]=S(t[n]);return e}return t}function j(t,e){return function e(n,i){Object.keys(i||{}).forEach(function(t){"object"==typeof n[t]?n[t]=e(n[t],i[t]):n[t]=W(n[t],i[t])});return n}(S(e),S(t))}var A=R;var N={data:function(){return{dragData:{id:null},process:{}}},computed:{id:function(){return this.daemonId},ready:function(){return this.process.daemon.init},pids:function(){return Object.keys(this.process||{})||[]},taskIds:function(){var e=this;return this.pids.filter(function(t){return e.process[t]&&e.process[t].isTask})},viewIds:function(){var e=this;return this.pids.filter(function(t){return e.process[t]&&e.process[t].isHasView})},dragProcess:function(){return this.dragId&&this.process[this.dragId]||null}},created:function(){this.processPut({id:"daemon",mode:"daemon",isTask:!0,isHasView:!1,hasContentWindow:!0,contentWindow:this.$ddvMultiWindowGlobal.contentWindow}),this.$ddvMultiWindowGlobal.daemonInit(this),this.process.daemon.init=!0}};function L(e){return new Promise(function(t){return setTimeout(t,e)})}function x(e,n,i,o){return(i=i||50)<o?(console.error(e,n),Promise.reject(new Error("\u67e5\u627e\u5931\u8d25"))):(o=(o||0)+1,e[n]?Promise.resolve(e[n]):L(60).then(function(t){return x(e,n,i,o)}))}var H,B=require("jquery"),V={methods:{regTask:function(t){var e=this.process[t];if(!e)throw new Error("\u6ca1\u6709\u627e\u5230\u4efb\u52a1\u680f\u7a97\u53e3");e.isTask&&Array.isArray(e.pids)||(this.$set(e,"isTask",!0),this.$set(e,"pids",[]),this.$set(e,"history",[]),this.$set(e,"activeId",null))},addTask:function(t){var e=t.taskId,n=t.id,i=this.process[e].pids;-1<i.indexOf(n)||i.push(n)},refreshTask:function(t){var n=this,i=t.taskId,o=t.id;(this.taskIds||[]).forEach(function(t){var e=n.process[t];e&&t!==i&&(e.pids=e.pids.filter(function(t){return t!==o}),e.history=e.history.filter(function(t){return t!==o}))})},windowAppendChild:function(t,e){var n,i,o=this,r=t.id,s=t.taskId,a=t.autoToTab;return 50<e?Promise.reject(new Error("\u67e5\u627e\u5931\u8d25")):(e=(e||0)+1,r&&(n=this.process[r])?n.removeing?Promise.resolve():n.$mainWrap&&n.$mainWrap[s]?(n.$mainWrap[s].append(n.$content),i=n.taskId,n.taskId=s,!1===a?Promise.resolve():this.tabToWindow(r).then(function(){return o.refreshTask({taskId:s,id:r}),o.tabToLastWindowByTaskId(i||"daemon")})):L(350).then(function(){return o.windowAppendChild({id:r,taskId:s,autoToTab:a},e)}):Promise.resolve())},viewMoveParentByPid:function(t){var e=this.process[t];e&&e.$parent&&e.$parent.length&&e.$content&&e.$content.length&&e.$parent.append(e.$content)},closeMasterWindow:function(t,e){var n=this,i=this.process[t||"daemon"];if(i&&(this.masterMoveParentByTaskId(t),!1!==e)){if(!0===e||e<=0){var o=this.process.daemon,r=i.activeId;if("master"!==i.mode)return;(i.history||[]).forEach(function(t){-1<o.history.indexOf(t)||o.history.push(t)});var s=(i.pids||[]).map(function(t){return n.addTask({taskId:"daemon",id:t}),n.windowAppendChild({taskId:"daemon",id:t,autoToTab:!1})});return i.hasContentWindow&&i.contentWindow&&!i.contentWindow.closed&&i.contentWindow.close(),Promise.all(s).then(function(){return i.pids.length=0,n.refreshTask({taskId:"daemon",id:r})})}clearTimeout(i.closeMasterTimer),i.closeMasterTimer=setTimeout(function(){n.closeMasterWindow(t,0)},e||5e3)}},closeAllMasterWindow:function(){var e=this.$ddvMultiWindowGlobal&&this.$ddvMultiWindowGlobal.map&&this.$ddvMultiWindowGlobal.map[this.daemonId]&&this.$ddvMultiWindowGlobal.map[this.daemonId].api;this.taskIds.forEach(function(t){Object.keys(e).forEach(function(t){e&&e[t]&&"function"==typeof e[t].onDaemonClose&&e[t].onDaemonClose()})})},masterMoveParentByTaskId:function(t){var e=t&&this.process[t];e&&(e.$mainParent&&e.$mainContent&&e.$mainParent.append(e.$mainContent),e.$taskParent&&e.$taskContent&&e.$taskParent.append(e.$taskContent))},masterViewInit:function(t,e,n){var i,o=this,r=this.process[e];return"view"===t?i="$mainContent":"task"===t&&(i="$taskContent"),r?(clearTimeout(r.closeMasterTimer),r[i]?r[i].length?n&&B(n).length?(n.append(r[i]),Promise.resolve()):Promise.reject(f("\u8fdb\u7a0b\u4e0d\u5b58\u5728")):Promise.reject(f("\u4efb\u52a1\u680f\u4e2d\u6ca1\u6709\u627e\u5230\u6302\u8f7d\u70b9")):x(r,i).then(function(){return o.masterViewInit(t,e,n)})):Promise.reject(f("\u8fdb\u7a0b\u4e0d\u5b58\u5728"))}}},U={methods:{tryRun:function(t){var n=this;return this._dmw$tryRun(t).catch(function(e){return n.errorHooks.length?Promise.all(n.errorHooks.map(function(t){return t&&t(e)})):Promise.reject(e)})},_dmw$tryRun:function(t){if("function"==typeof t)try{var e=t();return e&&e.then?e:Promise.resolve(e)}catch(t){return Promise.reject(t)}return Promise.resolve()},createPid:function(t){return(t.mode||"child")+m()},isHasId:function(t){return-1<this.pids.indexOf(t)},checkPid:function(t,e,n){var i=this,o=0!==e;return o&&e<n?d("Window does not exist","WINDOW_NOT_EXIST",o):(n=(n||0)+1,this.isHasId(t)?o?Promise.resolve():void 0:o?L(150).then(function(){return i.checkPid(t,e,n)}):d("Window does not exist","WINDOW_NOT_EXIST",o))},getPidByWindow:function(t,e,n){var i,o,r,s=this,a=0!==e;if(e=W(e,50),a&&e<n)return d("Find pid based on window","FIND_PID_FAIL_BY_CW",a);for(i in n=(n||0)+1,s.process)if((o=s.process[i]).hasContentWindow)if(!o.contentWindow||o.contentWindow.closed)r=!0;else if(o.contentWindow===t)return a?Promise.resolve(i):i;return a&&r?a?this.dmw$handleContentWindowLoad().then(function(){return L(150)}).then(function(){return s.getPidByWindow(t,e,n)}):d("Process contentWindow not has init or closed","PROCESS_CW_NOT_INIT_OR_CLOSED",a):d("window not found","WINDOW_NOT_FINT",a)},getWindowByPid:function(t,e,n){var i=this,o=0!==e;if(e=W(e,50),o&&e<n)return d("Find window  based on pid","FIND_CW_FAIL_BY_PID",o);if(n=(n||0)+1,!t)return d("must input pid","MUST_INPUT_PID",o);var r=this.process[t];return r?r.hasContentWindow?!r.contentWindow||r.contentWindow.closed?o?this.dmw$handleContentWindowLoad().then(function(){return L(150)}).then(function(){return i.getWindowByPid(t,e,n)}):d("Process contentWindow not has init or closed","PROCESS_CW_NOT_INIT_OR_CLOSED",o):o?Promise.resolve({contentWindow:r.contentWindow}):r.contentWindow:d("Process not has contentWindow","PROCESS_NOT_CW",o):d("Process data not found","PROCESS_NOT_FIND",o)},processPut:function(t){t.id=t.id||t.pid;this.$set(this.process,t.id,k(t,{mode:null,error:null,isTask:!1,isHasTask:!0,isHasView:!0,init:!1,refinit:!1}))},routerReady:function(){var n=this;return new Promise(function(t,e){return n.$router.onReady(t,e)})}}},G={props:{daemonId:{type:[Number,String],default:"daemon"},modeNotTasks:{type:Array,default:function(){return["daemon","master"]}},openMasterWindowSrc:{type:String,default:"/"},renderOptions:{type:Object,default:function(){return{root:{},daemon:{},views:{},mains:{},tasks:{},taskParent:{},taskBox:{},mainParent:{},mainBox:{style:{width:"100%",height:"100%"}},mainContent:{style:{width:"100%",height:"100%"}},viewParent:{},viewBox:{style:{width:"100%",height:"100%"}},viewLoad:{},viewError:{},viewComponent:{},viewIframe:{attrs:{frameborder:0,width:"100%",height:"100%",allowtransparency:!0}}}}}}};function Y(t){if(t&&(H=t),t||"undefined"==typeof window||(H=window),!H)throw f("\u6ca1\u6709\u627e\u5230\u7a97\u53e3");return H}var F={methods:{tabToWindow:function(e){if(!this.isHasId(e))return Promise.reject(f("\u7a97\u53e3\u4e0d\u5b58\u5728"));var t=this.process[this.process[e].taskId||"daemon"];return t.activeId=e,I(t.history,function(t){return t===e}),t.history.unshift(e),Promise.resolve()},tabToLastWindowByTaskId:function(t){var e=this.process[t||"daemon"];return"daemon"===t||e.pids&&e.pids.length?e&&e.history[0]&&this.tabToWindow(e.history[0]):this.closeMasterWindow(t,0)||Promise.resolve()},tabMoveMasterWindow:function(t){var e=t.taskId,n=t.id;return this.regTask(e),this.addTask({taskId:e,id:n}),this.windowAppendChild({taskId:e,id:n})},openMasterWindow:function(t){try{var e=this.createPid({mode:"master"}),n=function(t,e,n){var i,o,r;if(!n){if("undefined"==typeof window||window.window!==window)throw f("window must input","WINDOW_MUST_INPUT");n=window}try{i=n.open(t,e.name||"",function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n+"="+t[n]);return e.join(",")}((r=n,(o=(o=e)||{}).width=o.width||640,o.height=o.height||480,o.left=o.left||r.screenX+(r.outerWidth-o.width)/2,o.top=o.top||r.screenY+(r.outerHeight-o.height)/2.5,o)))}catch(t){}if(i)return i;throw f("open window fail","OPEN_WINDOW_FAIL")}(this.openMasterWindowSrc,{name:e},this.daemonWindow||this.contentWindow);return this.processPut({id:e,mode:"master",isTask:!0,isHasView:!1,hasContentWindow:!0,contentWindow:n}),this.tabMoveMasterWindow({id:t,taskId:e})}catch(t){return Promise.reject(t)}}}};var X=/[!'()*]/g,q=function(t){return"%"+t.charCodeAt(0).toString(16)},K=/%2C/g,J=function(t){return encodeURIComponent(t).replace(X,q).replace(K,",")};var z={methods:{open:function(e,t){var i,n,o={src:"/",title:"New window",closable:!0,refreshable:!0,removeing:!1,contentWindow:null,$content:null,$iframe:null,$parent:null,$mainWrap:{},hook:{beforeRefresh:[]},component:null},r=Object.create(null);if("string"==typeof e)r.src=e,r.options={src:e};else if("object"==typeof e){if(!e.src&&e.path){var s=e.path;e.query&&(s+=(i=e.query,(n=i?Object.keys(i).map(function(e){var t=i[e];if(void 0===t)return"";if(null===t)return J(e);if(Array.isArray(t)){var n=[];return t.forEach(function(t){void 0!==t&&(null===t?n.push(J(e)):n.push(J(e)+"="+J(t)))}),n.join("&")}return J(e)+"="+J(t)}).filter(function(t){return 0<t.length}).join("&"):null)?"?"+n:"")),e.src=s}Object.keys(o).forEach(function(t){Object.hasOwnProperty.call(e,t)&&(r[t]=e[t]),r.options=e})}if(r.src){var a=this.$router.getMatchedComponents(r.src);if(r.mode||(r.mode=a.length?"component":"iframe"),a.length){var d=this.$router.resolve(r.src),c=d.route,h=d.href;r.src=h,r.route=c}}else if("object"==typeof e){var u=this.$router.resolve(e),l=u.route,p=u.href;r.src=p,r.route=l}return r.taskId="object"==typeof e?e.taskId||t:r.taskId||t,r.mode=r.mode||"iframe",r.id||(r.id=this.createPid({mode:r.mode})),r.isHasTask=-1===this.modeNotTasks.indexOf(r.mode),r.hasContentWindow=void 0===r.hasContentWindow?-1<["iframe","daemon","master"].indexOf(r.mode):r.hasContentWindow,k(Object.assign(r,{daemonId:this.daemonId}),o),r.title=r.title||"\u65b0\u7a97\u53e3[id:"+r.id+"]",!r.isHasTask||this.process[r.taskId]&&this.process[r.taskId].isTask||(r.taskId="daemon"),r.isHasTask&&(this.regTask(r.taskId),this.addTask({taskId:r.taskId,id:r.id})),this.processPut(r),this.tabToWindow(r.id)},remove:function(n){var i=this,t=this.process[n];return this.isHasId(n)?!1===t.closable?Promise.reject(new Error("this window cannot be closed")):(t.removeing=!0,this.viewMoveParentByPid(n),this.taskIds.forEach(function(t){var e=i.process[t];e&&(I(e.pids,function(t){return t===n}),I(e.history,function(t){return t===n}))}),this.$delete(this.process,n),this.tabToLastWindowByTaskId(t.taskId||"daemon")):Promise.reject(new Error("this window is not found"))},refresh:function(t){var e=this.process[t];if(!this.isHasId(t))return Promise.reject(new Error("this window is not found"));if(!1===e.refreshable)return Promise.reject(new Error("this window does not support refresh"));if("component"!==e.mode)return"iframe"===e.mode?this.getWindowByPid(t).then(function(t){t.contentWindow.location.reload(!0)}):Promise.reject(new Error("window does not support refresh"));if(e.component){if(Array.isArray(e.hook.beforeRefresh))for(var n=0;n<e.hook.beforeRefresh.length;n++){var i=e.hook.beforeRefresh[n];if(h(i))if(!1===i())return Promise.resolve()}e.component=null}}}},Q=require("jquery");function Z(e,n){return e.push(n),function(){var t=e.indexOf(n);-1<t&&e.splice(t,1)}}var tt={methods:{loadComponent:function(t){var e=this,n=this.process[t];return n&&n.isHasView?"component"!==n.mode?d("\u4e0d\u652f\u6301\u52a0\u8f7d"):(n.error=null,this.routerReady().then(function(){return e.$router.getMatchedComponents(n.src)}).then(function(t){if(!t.length){var e=new Error("404");return e.statusCode=404,Promise.reject(e)}return Promise.all(t.map(function(t){return t()}))}).then(function(t){n.component=Object.create(t[0]),(n.component.process=n).component.router=e.loadComponentRouter(n,n.component)}).catch(function(t){console.log("e",t),n.error=t})):d("\u4e0d\u652f\u6301\u663e\u793a")},loadComponentRouter:function(t,e){var n=Object.create(null);return Object.assign(n,et,{daemonApp:this,$parentRouter:this.$router,process:t,options:this.$router.options}),n}}},et={resolve:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return this.$parentRouter.resolve.apply(this.$parentRouter,t)},init:function(t){t._route=this.process.route,this.$vm=t,this.history={},this.history.current=Object.assign({},this.process.route)},push:function(e,t,n){if(!this.$vm.$ddvMultiWindow)return this.daemonApp.$ddvMultiWindowGlobal.get(this.process.daemonId,this.process.taskId).then(function(t){return t.open(e)});this.$vm.$ddvMultiWindow.open(e)},replace:function(t,e,n){this.history.current=this.resolve(t).route}},nt={name:"ddv-multi-window-daemon",mixins:[N,V,F,U,G,z,{methods:{dmw$iframeLoad:function(e,t){var n,i=this;return e&&(n=this.process[e])?"iframe"!==n.mode||n.removeing?Promise.resolve():Promise.resolve().then(function(){if(!n.$iframe)return x(i.$refs,"if_"+e).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,n.$iframe=Q(t)})}).then(function(){if((t||!n.contentWindow||n.contentWindow.closed)&&(n.contentWindow=n.$iframe[0]&&n.$iframe[0].contentWindow||null,!n.contentWindow||n.contentWindow.closed))return L(500).then(function(t){return i.dmw$iframeLoad(e,!0)})}):Promise.resolve()},dmw$mainWrapInit:function(t){var n,i=this;return t&&(n=this.process[t])?n.removeing||!n.isHasView?Promise.resolve():Promise.all((this.taskIds||[]).map(function(e){if(n.$mainWrap||i.$set(n,"$mainWrap",{}),!n.$mainWrap[e])return x(i.$refs,"mc_"+e+"_p_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,n.$mainWrap[e]=Q(t)})})):Promise.resolve()},dmw$viewInit:function(t){var e,n=this;return t&&(e=this.process[t])?e.removeing||!e.isHasView?Promise.resolve():e.refinit?this.dmw$mainWrapInit(t):Promise.resolve().then(function(){if(!e.$parent)return x(n.$refs,"vp_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$parent=Q(t)})}).then(function(){if(!e.$content)return x(n.$refs,"vb_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$content=Q(t)})}).then(function(){return n.dmw$mainWrapInit(t)}).then(function(){return e.refinit=!0,"iframe"===e.mode?(e.init=!0,n.dmw$iframeLoad(t)):"component"===e.mode?n.loadComponent(t).then(function(){e.init=!0}).catch(function(t){e.error=t}):void 0}).then(function(){e.init=!0}).then(function(){return n.$ddvMultiWindow.windowAppendChild({id:t,taskId:e.taskId})}):Promise.resolve()},dmw$taskInit:function(t){var e,n=this;if(t&&(e=this.process[t])&&!e.refinit&&!e.removeing&&e.isTask)return Promise.resolve().then(function(){if(!e.$taskParent)return x(n.$refs,"tp_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$taskParent=Q(t)})}).then(function(){if(!e.$taskContent)return x(n.$refs,"tb_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$taskContent=Q(t)})}).then(function(){if(!e.$mainParent)return x(n.$refs,"mp_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$mainParent=Q(t)})}).then(function(){if(!e.$mainContent)return x(n.$refs,"mb_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$mainContent=Q(t)})}).then(function(){e.refinit=!0})},dmw$processInit:function(){var n=this,e=[];return this.pids.forEach(function(t){return e.push()}),Promise.all(this.pids.map(function(t){var e;return t&&(e=n.process[t])?e.isHasView?n.dmw$viewInit(t):e.isTask?n.dmw$taskInit(t):Promise.resolve():Promise.resolve()}))},dmw$ddvMultiWindowMapInit:function(){var e=this,n=this.$ddvMultiWindowGlobal.map[this.daemonId];return Promise.all(this.taskIds.map(function(t){n.api[t]||(n.api[t]=new s(n.app,t))}).concat(Object.keys(n.api||{}).map(function(t){-1<e.taskIds.indexOf(t)||e.$delete(n.api,t)})))},dmw$handleContentWindowLoad:function(){return Promise.all([this.dmw$handleMasterWindowLoad(),this.dmw$handleIframeLoad()])},dmw$handleMasterWindowLoad:function(){var n=this;return Promise.resolve(this.pids.map(function(t){if(!t||!n.process)return Promise.resolve();var e=n.process[t];return e&&e.hasContentWindow,Promise.resolve()}))},dmw$handleIframeLoad:function(t,e){var n=this;return this.tryRun(function(t){return L(300).then(function(t){return n.dmw$iframeLoad(e)})})},dmw$handlePidsChange:function(){var e=this;return this.tryRun(function(t){return Promise.all([e.dmw$processInit()])})},dmw$handleTaskIdsChange:function(){var e=this;return this.tryRun(function(t){return e.dmw$ddvMultiWindowMapInit()})},dmw$onbeforeunload:function(t){return t.returnValue="\u5173\u95ed\u4f1a\u5bfc\u81f4\u6240\u6709\u7a97\u53e3\u90fd\u5173\u95ed\uff0c\u60a8\u786e\u8ba4\u5173\u95ed","\u5173\u95ed\u4f1a\u5bfc\u81f4\u6240\u6709\u7a97\u53e3\u90fd\u5173\u95ed?"},dmw$handleCloseInit:function(){var t=this.$ddvMultiWindowGlobal.contentWindow;t.addEventListener("close",this.closeAllMasterWindow.bind(this)),t.addEventListener("unload",this.closeAllMasterWindow.bind(this)),t.addEventListener("beforeunload",this.dmw$onbeforeunload.bind(this))}},watch:{taskIds:{handler:"dmw$handleTaskIdsChange",deep:!0},pids:{handler:"dmw$handlePidsChange",deep:!0}},mounted:function(){this.dmw$handleCloseInit()}},{methods:{handleTask:function(t,e,n){var i=this;return this.$ddvMultiWindow.tryRun(function(){return i["handleTask$"+e](t,n)})},handleTask$click:function(t,e){return t.stopPropagation(),t.preventDefault(),this.$ddvMultiWindow.tabToWindow(e)},handleTask$refresh:function(t,e){return t.stopPropagation(),t.preventDefault(),this.$ddvMultiWindow.refresh(e)},handleTask$openMasterWindow:function(t,e){return t.stopPropagation(),t.preventDefault(),this.$ddvMultiWindow.openMasterWindow(e)},handleTask$remove:function(t,e){return t.stopPropagation(),t.preventDefault(),this.$ddvMultiWindow.remove(e)},handleTask$removeAll:function(t,e){var n=this;t.stopPropagation(),t.preventDefault();var i=[];return this.process[e].pids.forEach(function(t){return n.process[t]&&!1!==n.process[t].closable&&i.push(n.$ddvMultiWindow.remove(t))}),Promise.all(i)},handleTask$contextMenu:function(t,e){t.stopPropagation(),t.preventDefault(),console.log("\u53f3\u952e")}}},{methods:{onBeforeOpen:function(t){return Z(this.beforeOpenHooks,t)},onOpened:function(t){return Z(this.openedHooks,t)},onBeforeRemove:function(t){return Z(this.beforeRemoveHooks,t)},onBeforeRefres:function(t){return Z(this.beforeRefresHooks,t)},onRefreshed:function(t){return Z(this.refreshedHooks,t)},onReady:function(n,i){var o=this;return this.readyCbs.push(n),i&&this.errorHooks.push(i),function(){var t=o.readyCbs.indexOf(n),e=o.errorHooks.indexOf(i);-1<t&&o.readyCbs.splice(t,1),-1<e&&o.errorHooks.splice(e,1)}},onError:function(t){return Z(this.errorHooks,t)}},beforeCreate:function(){this.readyCbs=[],this.errorHooks=[],this.openedHooks=[],this.refreshedHooks=[],this.beforeOpenHooks=[],this.beforeRemoveHooks=[],this.beforeRefresHooks=[]}},tt],render:function(t){if(this.ready){var e=this.$slots.default?Array.prototype.concat(this.$slots.default):[];return e.push(t("div",j(this.renderOptions.daemon,{key:"daemon_wrap",directives:[{name:"show",rawName:"show",value:!1}]}),[function(t){return t("div",j(this.renderOptions.mains,{key:"mains",attrs:{"ddv-multi-window-type":"mains"}}),function(i){var o=this;return this.taskIds.map(function(e){var n=o.process[e];if(n&&n.isTask)return i("div",j(o.renderOptions.mainParent,{key:e,ref:"mp_"+e,attrs:{"task-id":e,"ddv-multi-window-type":"mainParent"}}),[i("div",j(o.renderOptions.mainBox,{key:"main",ref:"mb_"+e,attrs:{"task-id":e,"ddv-multi-window-type":"mainBox"}}),(o.viewIds||[]).map(function(t){return i("div",j(o.renderOptions.mainContent,{key:t,ref:"mc_"+e+"_p_"+t,attrs:{"task-id":e,"process-id":t,"ddv-multi-window-type":"mainContent"},directives:[{name:"show",rawName:"show",value:n&&t===n.activeId}]}))}))])})}.call(this,t))}.call(this,t),function(t){return t("div",j(this.renderOptions.views,{key:"views",attrs:{"ddv-multi-window-type":"views"}}),function(i){var o=this;return this.viewIds.map(function(e){var n=o.process[e];if(n&&n.isHasView){var t=[];return n.init?n.error?t.push(i(A,j(o.renderOptions.viewError,{key:"error",attrs:{"process-id":e,"ddv-multi-window-type":"errorBox"},props:{error:o.error}}))):"component"===n.mode?n.component?t.push(i(n.component,j(o.renderOptions.viewComponent,{props:{}}))):(n.init=!1,o.loadComponent(e).then(function(){n.init=!0}).catch(function(t){n.error=t})):"iframe"===n.mode&&t.push(i("iframe",j(o.renderOptions.viewIframe,{key:"iframe",ref:"if_"+e,on:{load:function(t){return o.dmw$handleIframeLoad(t,e)}},attrs:{src:n.src,"process-id":e,"ddv-multi-window-type":"iframe"}}))):t.push(i(R,j(o.renderOptions.viewLoad,{key:"load",attrs:{"process-id":e,"ddv-multi-window-type":"loadBox"}}))),i("div",j(o.renderOptions.viewParent,{key:e,ref:"vp_"+e,attrs:{"process-id":e,"ddv-multi-window-type":"viewParent"}}),[i("div",j(o.renderOptions.viewBox,{key:"view",ref:"vb_"+e,attrs:{"process-id":e,"ddv-multi-window-type":"viewBox"}}),t)])}})}.call(this,t))}.call(this,t),function(t){return t("div",j(this.renderOptions.tasks,{key:"tasks",attrs:{"ddv-multi-window-type":"tasks"}}),function(n){var i=this;return this.taskIds.map(function(t){var e=i.process[t];if(e&&e.isTask)return n("div",j(i.renderOptions.taskParent,{key:t,ref:"tp_"+t,attrs:{"process-id":t,"ddv-multi-window-type":"taskParent"}}),[n("div",j(i.renderOptions.taskBox,{key:"task",ref:"tb_"+t,attrs:{"process-id":t,"ddv-multi-window-type":"taskBox"}}),function(t,e){var n={task:e,process:this.process,handleTask:this.handleTask},i=[];return this.$scopedSlots&&this.$scopedSlots.task?i.push(this.$scopedSlots.task(n)):i.push(t(E,{key:"task",attrs:{"ddv-multi-window-type":"taskContent"},props:n})),i}.call(i,n,e))])})}.call(this,t))}.call(this,t)])),t("div",j(this.renderOptions.root,{key:"root",attrs:{id:"dmw_daemon_"+this.id,"ddv-multi-window-type":"root"}}),e)}}},it={name:"ddv-multi-window-button",props:{to:{type:[String,Object]},type:{type:String,default:"open"},tag:{type:String,default:"button"},daemonId:{type:[Number,String],default:"daemon"},taskId:{type:[Number,String],default:""},event:{type:[String,Array],default:"click"},title:{type:String}},data:function(){return{ddvMultiWindowReady:!1,error:null}},render:function(t){var e=this,n={click:ot};return Array.isArray(this.event)?this.event.forEach(function(t){n[t]=e.handler.bind(e)}):n[this.event]=this.handler.bind(this),t(this.tag,{on:n},this.$slots.default)},methods:{masterInit:function(){var e=this;this.$ddvMultiWindowGlobal.masterInit(this).then(function(){e.ddvMultiWindowReady=!0},function(t){console.error(t),e.error=t})},handler:function(t){var e=this;if(ot(t)){var n=t.currentTarget.getAttribute("target")||this.taskId,i=j("string"==typeof this.to?{src:this.to}:S(this.to),{taskId:n});if(this.title&&(i.title=this.title),!this.ddvMultiWindowReady)return this.$ddvMultiWindowGlobal.masterInit(this).then(function(){e.comply(i)});this.comply(i)}},comply:function(t){var e=this;this.$ddvMultiWindow.tryRun(function(){switch(e.type){case"open":return e.$ddvMultiWindow.open(t);case"close":case"remove":return e.$ddvMultiWindow.remove(e.$router.process.id);default:return Promise.reject(new Error("this operation is not supported yet"))}})}},created:function(){this.$isServer||this.masterInit()}};function ot(t){if(!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey||t.defaultPrevented))return t.preventDefault&&t.preventDefault(),!0}var rt={name:"ddv-multi-window-error",props:{view:{type:String,default:"view"},error:{}},render:function(t){return t("section",[t("div",{},[this.message])])},computed:{message:function(){return this.error.message||"\u51fa\u9519\u4e86"}}},st=require("jquery"),at={name:"ddv-multi-window-master",props:{daemonId:{type:[Number,String],default:"daemon"},view:{type:String,default:"view"},autoColse:{type:Boolean,default:!0}},data:function(){return{ddvMultiWindowReady:!1,refReady:!1,error:null,init:!1,wrap:null,$wrap:null}},render:function(t){var e=[];return this.error?e.push(t(rt,{key:"error",attrs:{"ddv-multi-window-type":"errorBox"},props:{view:this.view,error:this.error}})):this.init||e.push(t(R,{key:"load"})),t("div",{key:"master",ref:"m",attrs:{id:"dmw_master_"+this.view+this.id,"ddv-multi-window-type":"master"+this.view}},e)},methods:{masterInit:function(){var e=this;this.$ddvMultiWindowGlobal.masterInit(this).then(function(){e.$ddvMultiWindow.onDaemonClose=e.onDaemonClose.bind(e),e.ddvMultiWindowReady=!0},function(t){console.error(t),e.error=t})},refReadyInit:function(){var e=this;return Promise.resolve().then(function(){if(!e.wrap)return x(e.$refs,"m").then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.wrap=t,e.$wrap=st(e.wrap)})}).then(function(){e.refReady=!0})},closeWindow:function(){try{this.contentWindow.close()}catch(t){try{window.close()}catch(t){}}},closeMasterWindow:function(){try{this.$ddvMultiWindow.closeMasterWindow(this.taskId,5e3)}catch(t){this.closeWindow()}},masterViewInit:function(){var t=this;if(this.masterReady){var e=this.contentWindow;e.addEventListener("close",this.closeMasterWindow.bind(this)),e.addEventListener("unload",this.closeMasterWindow.bind(this)),this.$ddvMultiWindow.masterViewInit(this.view,this.taskId,this.$wrap).then(function(){t.init=!0})}},onDaemonClose:function(){var t=this;this.$ddvMultiWindow.masterMoveParentByTaskId(this.taskId),this.error=new Error("\u4e3b\u7a97\u53e3\u88ab\u5173\u95ed"),this.autoColse&&setTimeout(function(){t.closeWindow()},1500)}},computed:{taskId:function(){return this.ddvMultiWindowReady?this.$ddvMultiWindow.taskId:null},contentWindow:function(){return this.$ddvMultiWindowGlobal.contentWindow},masterReady:function(){return this.refReady&&this.ddvMultiWindowReady}},watch:{masterReady:{handler:"masterViewInit"}},created:function(){this.$isServer||this.masterInit()},mounted:function(){this.$isServer||this.refReadyInit()}},dt={name:"dmw-button",functional:!0,render:function(t,e){var n=e.data,i=e.children,o=e.props;return n.props=o,t(it,n,i)}},ct={name:"ddv-multi-window-task",functional:!0,props:{daemonId:{type:[Number,String],default:"daemon"}},render:function(t,e){var n=e.data,i=e.children,o=e.props;return o.view="task",n.props=o,t(at,n,i)}},ht={name:"ddv-multi-window-view",functional:!0,props:{daemonId:{type:[Number,String],default:"daemon"}},render:function(t,e){var n=e.data,i=e.children,o=e.props;return o.view="view",n.props=o,t(at,n,i)}};function ut(t,e){return(t=t||this)&&t[e]?t[e]:t&&t.$parent?ut(t.$parent,e):null}var lt=function(){this.Vue=null};lt.prototype.masterInit=function(e){var n=this;if(!this.Vue.prototype.$isServer){if(!this.installed)throw f("not installed. Make sure to call `Vue.use(DdvMultiWindow)`before creating root instance.");if(!e)throw f("\u5fc5\u987b\u4f20\u5165app\u5b9e\u4f8b");var t=ut(e,"_ddvMultiWindow");if(t)return Promise.resolve(t);var i=e.daemonId;return this.get(i).then(function(t){try{n.contentWindow&&t&&(n.contentWindow.name=t.taskId)}catch(t){}return e._ddvMultiWindow=t})}},lt.prototype.daemonInit=function(t){if(!this.Vue.prototype.$isServer){var e=t.daemonId;return e?(this.map[e]||(this.map[e]={app:t,api:{}}),t._ddvMultiWindow=this.get(e,"daemon",0)):d("not installed. Make sure to call `daemonInit(app)`before creating root instance.","DAEMON_NOT_INIT",!1)}},lt.prototype.get=function(t,e,n,i){var o=0!==n;if(!this.installed)return d("not installed. Make sure to call `Vue.use(DdvMultiWindow)`before creating root instance.","MUST_VUE_USE_DDV_MULTI_WINDOW",o);var r=this.map[t];return r&&r.app&&r.api?e&&r.api[e]?o?Promise.resolve(r.api[e]):r.api[e]:"daemon"===e?(r.api.daemon=new s(r.app,e),o?Promise.resolve(r.api.daemon):r.api.daemon):(e=r.api.daemon.getPidByWindow(this.contentWindow,n,i),o?e.then(function(t){return t&&!r.api[t]&&(r.api[t]=new s(r.app,t)),Promise.resolve(r.api[t])}):(e&&!r.api[e]&&(r.api[e]=new s(r.app,e)),r.api[e])):d("daemonId does not exist","DAEMONID_NOT_EXIST",o)},lt.prototype.install=function(t,e){if(!this.installing&&!this.installed||this.Vue!==t){if(this.installing=!0,this.Vue=t,this.options=e,this.VueInstall(t),t.prototype.$isServer)return this.installing=!1,void(this.installed=!0);this.optionsInstall(),this.daemonWindowInstall(),this.namespaceReg(),this.mapInstall(),this.installing=!1,this.installed=!0}},lt.prototype.mapInstall=function(){if(!this.map&&(this.contentWindow===this.daemonWindow?this.map=Object.create(null):this.daemonWindow&&this.daemonWindow[this.namespace]&&(this.map=this.daemonWindow[this.namespace].map||this.map),!this.map))throw f("Initialization failed, check if the 'options.namespace' is consistent with the daemon window")},lt.prototype.daemonWindowInstall=function(){this.options.window||(this.options.window=void 0===typeof window?this.options.window:window),this.contentWindow=Y(this.options.window),this.daemonWindow=function t(e){var n,i;e=Y(e);try{n=e.location.host}catch(t){}if(!i||i===e)try{if(e.parent&&e.parent.location&&n===e.parent.location.host)try{e.parent.$ddvUtil&&e.parent.$ddvUtil.$daemonWindow&&e.parent.$ddvUtil.$daemonWindow.location&&n===e.parent.$ddvUtil.$daemonWindow.location.host&&(i=e.parent.$ddvUtil.$daemonWindow)}catch(t){}}catch(t){}if(!i||i===e)try{if(e.top&&e.top.location&&n===e.top.location.host){try{e.top.$ddvUtil&&e.top.$ddvUtil.$daemonWindow&&e.top.$ddvUtil.$daemonWindow.location&&n===e.top.$ddvUtil.$daemonWindow.location.host&&(i=e.top.$ddvUtil.$daemonWindow)}catch(t){}if(!i){i=e.top;try{e.top.opener&&e.top.opener.location&&n===e.top.opener.location.host&&(i=e.top.opener)}catch(t){}}}}catch(t){}if(!i||i===e)try{if(e.parent&&e.parent.location&&n===e.parent.location.host){i=e.parent;try{e.parent.opener&&e.parent.opener.location&&n===e.parent.opener.location.host&&(i=e.parent.opener)}catch(t){}}}catch(t){}if(!i||i===e)try{if(e.opener&&e.opener.location&&n===e.opener.location.host){try{e.opener.$ddvUtil&&e.opener.$ddvUtil.$daemonWindow&&e.opener.$ddvUtil.$daemonWindow.location&&n===e.opener.$ddvUtil.$daemonWindow.location.host&&(i=e.opener.$ddvUtil.$daemonWindow)}catch(t){}if(!i){i=e.opener;try{e.opener.opener&&e.opener.opener.location&&n===e.opener.opener.location.host&&(i=e.opener.opener)}catch(t){}}}}catch(t){}return i&&i!==e&&(i=t(i)),i||(i=e),i}(this.contentWindow),this.isDaemon=!this.contentWindow||this.contentWindow===this.daemonWindow;try{this.contentWindow&&(this.contentWindow.$ddvUtil||(this.contentWindow.$ddvUtil={}),this.contentWindow.$ddvUtil.$daemonWindow=this.daemonWindow)}catch(t){}},lt.prototype.optionsInstall=function(){this.options=k(this.options||{},{namespace:"__DDV_MULTI_WINDOW__"})},lt.prototype.namespaceReg=function(t){t=t||this.options.namespace,this.contentWindow[t]||(this.contentWindow[t]=this)},lt.prototype.VueInstall=function(t){t=t||this.Vue,this.hookInstall(t),this.componentInstall(t),this.VuePrototypeInstall(t),this.RegisterInstanceInstall(t)},lt.prototype.hookInstall=function(t){var e=t.config.optionMergeStrategies;e.beforeDdvMultiWindowOpen=e.ddvMultiWindowOpened=e.beforeDdvMultiWindowRemove=e.ddvMultiWindowRemoved=e.beforeDdvMultiWindowRefresh=e.ddvMultiWindowRefreshed=e.created},lt.prototype.componentInstall=function(t){t.component(E.name,E),t.component(nt.name,nt),t.component(it.name,it),t.component(at.name,at),t.component(dt.name,dt),t.component(ct.name,ct),t.component(ht.name,ht)},lt.prototype.RegisterInstanceInstall=function(t){this.Vue.mixin({beforeCreate:function(){var e=this;this._ddvProcess=this.$options.process,this._ddvProcess||(this._ddvProcess=ut(this.$parent,"_ddvProcess")),this._ddvProcess&&this.$options.beforeDdvMultiWindowRefresh&&this.$options.beforeDdvMultiWindowRefresh.length&&this._ddvProcess.hook.beforeRefresh.push.apply(this._ddvProcess.hook.beforeRefresh,this.$options.beforeDdvMultiWindowRefresh),this._ddvMultiWindow=ut(this.$parent,"_ddvMultiWindow"),!this._ddvMultiWindow&&this._ddvProcess&&this.$ddvMultiWindowGlobal.get(this._ddvProcess.daemonId,this._ddvProcess.taskId).then(function(t){e._ddvMultiWindow=t}),ft(this,this)},created:function(){},destroyed:function(){var e=this;this._ddvProcess&&this._ddvProcess.hook&&(this._ddvProcess.hook.beforeRefresh=this._ddvProcess.hook.beforeRefresh.filter(function(t){return e.$options.beforeDdvMultiWindowRefresh.indexOf(t)<0})),ft(this)}})},lt.prototype.VuePrototypeInstall=function(t){var e=this;t.prototype.hasOwnProperty("$ddvMultiWindow")||Object.defineProperty(t.prototype,"$ddvMultiWindow",{get:function(){if(this._ddvMultiWindow||(this._ddvMultiWindow=ut(this,"_ddvMultiWindow")),this._ddvMultiWindow)return this._ddvMultiWindow;throw f("Not initialized")}}),t.prototype.hasOwnProperty("$ddvMultiWindowGlobal")||Object.defineProperty(t.prototype,"$ddvMultiWindowGlobal",{get:function(){return e}})},lt.prototype.hasOwnProperty("namespace")||Object.defineProperty(lt.prototype,"namespace",{get:function(){return this.options&&this.options.namespace},set:function(t){return this.options=this.options||Object.create(null),this.options.namespace=t}});var pt=Object.assign(new lt,{isDaemon:!0,Ready:i,version:"0.1.4"});function ft(t,e){var n=t.$options._parentVnode;g(n)&&g(n=n.data)&&g(n=n.registerDdvMultiWindowInstance)&&n(t,e)}e&&window.Vue&&window.Vue.use(s),t._Vue=void 0,t.DdvMultiWindowGlobal=lt,t.default=pt,t.Ready=i,t.EventMessageWindow=u,Object.defineProperty(t,"__esModule",{value:!0})});