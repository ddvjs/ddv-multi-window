/*!
  * ddv-multi-window v0.1.8
  * (c) 2018 yuchonghua@163.com
  * @license MIT
  */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.DdvMultiWindow={})}(this,function(t){"use strict";function n(t,e){if(!t)throw new Error("[ddv-multi-window] "+e)}var r="undefined"!=typeof window;function o(t){return void 0!==t}function d(t,e){return o(t)?t:e}function v(e,i){return Object.keys(i).forEach(function(t){e[t]=d(e[t],i[t])}),e}function s(t){return"function"==typeof t}function e(t){if(this instanceof e)return i.apply(this,arguments);throw new e(t)}function i(t){this.promises=[],this.isReadyCb=void 0,this.ing=!1}e.prototype={isReady:function(){if(!0===this.isReadyd)return Promise.resolve();return new Promise(function(t,e){this.isReadyCb=[t,e]}.bind(this))},emitReady:function(t){if(this.isReadyd=!0,!(this.isReadyCb&&Array.isArray(this.isReadyCb)&&this.isReadyCb[0]))return;t&&this.isReadyCb[1]?this.isReadyCb[1](t):this.isReadyCb[0]&&this.isReadyCb[0]()},waitReady:function(){return new Promise(function(t,e){this.promises.push([t,e]),function(){if(this.ing)return;return this.ing=!0,this.runStartTime=new Date,function t(){return this.isReady&&"function"==typeof this.isReady?this.isReady():new Promise(function(t,e){new Date-this.runStartTime>this.initCheckTimeout?e(new Error("wait Ready Timeout")):setTimeout(t,this.initCheckInterval)}.bind(this)).then(function(){return t.call(this)}.bind(this))}.call(this).then(function(t){for(var e;(e=this.promises.splice(0,1))&&(e=e&&e[0])&&"function"==typeof e[0];)e[0](t);this.ing=!1}.bind(this)).catch(function(t){for(var e;(e=this.promises.splice(0,1))&&(e=e&&e[0])&&"function"==typeof e[1];)e[1](t);this.ing=!1}.bind(this))}.call(this)}.bind(this))},setIsReady:function(t){this.isReady=t},constructor:i,isReadyd:!1,isReadyCb:void 0,initCheckTimeout:3e3,initCheckInterval:100};var a=require("jquery");function l(t,e){!o(e)&&o(t)&&(e=t,t=void 0);var i=a(e);return t?i.closest(t):i}function c(i,n){var r=[];return i.forEach(function(t,e){n(t)&&r.push.apply(r,i.splice(e,1))}),r}var u={name:"ddv-multi-window-task-template",props:{task:{type:Object},process:{type:Object,default:{}},handleTask:{type:Function}},computed:{taskId:function(){return this.task?this.task.id:null},activeId:function(){return this.task?this.task.activeId:null},pids:function(){return this.task?this.task.pids:[]},dragData:function(){return this.$ddvMultiWindow.dragData||{}}},data:function(){return{tabTaskLiLists:{},isLeave:!1,isShowDropdown:!1}},methods:{setInfo:function(t){var e=this,i=l(this.$refs.tabTaskWrap),n=this.pids.length;this.dragData.event=t,this.dragData.interval=[],this.dragData.$dom&&this.dragData.$dom.length?this.dragData.activeWidth=this.dragData.$dom.innerWidth()||this.dragData.activeWidth||0:this.dragData.activeWidth=this.dragData.activeWidth||0,this.dragData.marginLeft=0,this.dragData.$dom.attr("dmwDrag","1");for(var r=0,o=0;o<n;o++){var s=l('[processid="'+e.pids[o]+'"]',e.$refs.tabTask),a=Number(s.css("margin-left").split("px")[0]),d=Number(s.css("margin-right").split("px")[0]),c=s.position(),u=s.is('[dmwDrag="1"]'),h={};e.dragData.marginLeft+=a,u?r=s.innerWidth()+a-d:(h.startX=c.left+a-r,h.endX=c.left+s.innerWidth()+a-d-r,h.pid=e.pids[o],e.dragData.interval.push(h))}this.dragData.marginLeft=Math.round(this.dragData.marginLeft/n),this.dragData.barStartY=i.position().top,this.dragData.barEndY=this.dragData.barStartY+i.outerHeight()},reduction:function(){l(this.$refs.menuArrow).css("margin-left",this.dragData.marginLeft+"px"),l('[active="active"]',this.$refs.tabTask).css("margin-left",this.dragData.marginLeft+"px").removeAttr("active")},handleTabDragStart:function(t,e){var i=l(this.$refs.tabTask);this.dragData.$dom=i.closest(t.target),l(this.$refs.tabTask).addClass("transition"),this.setInfo(t),this.dragData.id=e,this.dragData.taskId=this.taskId,this.dragData.rootTaskId=this.taskId,this.dragData.isCross=!1,t.ddvCmsTaskWindowId=e,t.dataTransfer.dropEffect="move",t.dataTransfer.effectAllowed="linkMove",t.dataTransfer.setData("ddvCmsDrag",JSON.stringify({type:"tabTask",data:{windowId:e}})),t.dataTransfer.setData("text/plain","http://www.baidu.com/sfa/ss")},handleTabDragEnd:function(t,e){var i=this;if(l(this.$refs.tabTask).removeClass("transition"),this.activeEvent=null,this.dragData.id=null,this.reduction(),this.dragData.$dom.removeAttr("dmwDrag").show(),this.dragData.taskId===this.taskId&&!(t.pageY>=this.dragData.barStartY&&t.pageY<=this.dragData.barEndY-2))return this.$ddvMultiWindow.tryRun(function(){return i.$ddvMultiWindow.openMasterWindow(e).catch(function(t){return"OPEN_WINDOW_FAIL"===t.name?i.$confirm("\u4f60\u662f\u5426\u8981\u5728\u65b0\u7a97\u53e3\u6253\u5f00","\u63d0\u793a",{confirmButtonText:"\u786e\u5b9a",cancelButtonText:"\u53d6\u6d88",type:"warning"}).then(function(){return i.$ddvMultiWindow.openMasterWindow(e)},function(t){}):Promise.reject(t)})})},handleTabWrapDragOver:function(t,e){var i=this;t.preventDefault();var n=l(this.$refs.tabTask),r=l(this.$refs.menuArrow);if(this.taskId!==this.dragData.taskId&&(l(this.$refs.tabTask).addClass("transition"),this.setInfo(this.dragData.event),this.dragData.isCross=this.dragData.rootTaskId!==this.taskId),this.dragData.taskId=this.taskId,t.pageY>=this.dragData.barStartY&&t.pageY<=this.dragData.barEndY-2){var o=!1;this.dragData.$dom.hide();for(var s=0;s<this.dragData.interval.length;s++){var a=i.dragData.interval[s];t.pageX>a.startX&&t.pageX<a.endX&&(o=!0,n.closest('[active="active"]').css("margin-left",i.dragData.marginLeft+"px").removeAttr("active"),l('[processid="'+a.pid+'"]',i.$refs.tabTask).css("margin-left",i.dragData.activeWidth+"px").attr("active","active"),r.css("margin-left",i.dragData.marginLeft+"px"),i.dragData.replaceId=a.pid,i.dragData.isLast=!1)}if(!o){n.closest('[active="active"]').length&&n.closest('[active="active"]').css("margin-left",this.dragData.marginLeft+"px").removeAttr("active");var d=this.dragData.interval[this.dragData.interval.length-1];d&&t.pageX>d.endX&&r.length&&r.css("margin-left",this.dragData.activeWidth+"px"),this.dragData.isLast=!0}}},handleTabWrapDragLeave:function(t){t.pageY>=this.dragData.barStartY&&t.pageY<=this.dragData.barEndY-2||this.reduction()},handleTabWrapDrop:function(t,e){var i=this;l(this.$refs.tabTask).removeClass("transition"),t.preventDefault();var n=this.pids.indexOf(this.dragData.replaceId),r=this.pids.indexOf(this.dragData.id),o=0;if(n!==r||0===this.pids.length){if(this.dragData.isLast)o=this.pids.length-1<=-1?0:this.pids.length-1;else{var s=[];this.pids.forEach(function(t){t!==i.dragData.id&&s.push(t)}),o=s.indexOf(this.dragData.replaceId)}var a="";this.dragData.isCross?(c(this.process[this.dragData.rootTaskId].pids,function(t){return t===i.dragData.id}),a=this.dragData.id):a=this.pids.splice(r,1)[0],this.pids.splice(o,0,a),this.reduction(),this.dragData.$dom.removeAttr("dmwDrag").show(),this.$ddvMultiWindow.tabMoveMasterWindow({taskId:this.taskId,id:this.dragData.id}),this.handleTask(t,"click",this.dragData.id)}else this.reduction(),this.dragData.$dom.removeAttr("dmwDrag").show()},pidsChange:function(){var t=this;this.$nextTick(function(){return t.tabTaskLiInit()})},tabTaskLiInit:function(){var n=this;this.pids&&Array.isArray(this.pids)&&this.pids.forEach(function(t){var e=l('[processid="'+t+'"]',n.$refs.tabTask),i=e[0];n.tabTaskLiLists[t]={dom:i,$:e,top:e.offset().top,left:e.offset().left,outerWidth:e.outerWidth(),outerHeight:e.outerHeight()}})}},watch:{pids:{deep:!0,handler:"pidsChange"}},destroyed:function(){},mounted:function(){}},h=function(){var i=this,t=i.$createElement,n=i._self._c||t;return n("section",{staticClass:"tabTask"},[n("div",{staticClass:"tabTask-menu"},[n("ul",{ref:"tabTaskWrap",staticClass:"tabTask-menu__ul clearfix",on:{dragover:function(t){return t.stopPropagation(),e=t,i.handleTabWrapDragOver(e,null);var e},dragleave:function(t){return t.stopPropagation(),e=t,i.handleTabWrapDragLeave(e);var e},drop:function(t){return t.stopPropagation(),e=t,i.handleTabWrapDrop(e,null);var e}}},[i._l(this.pids,function(e){return e&&i.process[e]?n("li",{key:e,ref:"tabTask",refInFor:!0,staticClass:"tabTask-menu__li",class:{"tabTask-menu__linow":e===i.activeId},attrs:{processid:e,draggable:"true"},on:{click:function(t){i.handleTask(t,"click",e)},contextmenu:function(t){i.handleTask(t,"contextMenu",e)},drop:function(t){t.stopPropagation(),i.handleTabWrapDrop(t,e)},dragstart:function(t){t.stopPropagation(),i.handleTabDragStart(t,e)},dragover:function(t){t.stopPropagation(),i.handleTabWrapDragOver(t,e)},dragend:function(t){t.stopPropagation(),i.handleTabDragEnd(t,e)}}},[n("div",{staticClass:"tabTask-menu__item"},[i._v(i._s(i.process[e].title))]),i._v(" "),n("div",{staticClass:"tabTask-menu__handle"},[n("div",{staticClass:"inline-block",on:{click:function(t){t.stopPropagation(),i.handleTask(t,"openMasterWindow",e)}}},[n("i",{staticClass:"dmw-icon icon-new-window f14"})]),i._v(" "),!1!==i.process[e].refreshable?n("div",{staticClass:"inline-block",on:{click:function(t){i.handleTask(t,"refresh",e)}}},[n("i",{staticClass:"dmw-icon icon-refresh f14"})]):i._e(),i._v(" "),!1!==i.process[e].closable?n("div",{staticClass:"inline-block",on:{click:function(t){i.handleTask(t,"remove",e)}}},[n("i",{staticClass:"dmw-icon icon-close f14"})]):i._e()])]):i._e()}),i._v(" "),n("li",{ref:"menuArrow",staticClass:"tabTask-menu__arrow",on:{mouseenter:function(t){i.isShowDropdown=!0},mouseleave:function(t){i.isShowDropdown=!1}}},[n("i",{staticClass:"dmw-icon icon-down-arrow tabTask-menu__pull f14"}),i._v(" "),n("transition",{attrs:{name:"fade"}},[n("ul",{directives:[{name:"show",rawName:"v-show",value:i.isShowDropdown,expression:"isShowDropdown"}],staticClass:"menu-dropdown"},[n("div",{staticClass:"menu-dropdown__arrow"}),i._v(" "),n("li",{staticClass:"menu-dropdown__item"},[n("div",{staticClass:"tabTask-menu__dropItem",on:{click:function(t){i.handleTask(t,"removeAll",i.task.id)}}},[n("div",{staticClass:"text-center"},[i._v("\u5173\u95ed\u5168\u90e8")])])]),i._v(" "),n("li",{staticClass:"menu-dropdown__item"},[n("div",{staticClass:"tabTask-menu__dropItem"},[n("div",{staticClass:"text-center tabTask-menu__manage"},[i._v("\u7ba1\u7406\u9ed8\u8ba4\u6807\u7b7e")])])]),i._v(" "),i.pids&&0<i.pids.length?n("li",{staticClass:"menu-dropdown__item-line"}):i._e(),i._v(" "),i._l(i.pids,function(e){return n("li",{key:e,staticClass:"menu-dropdown__item"},[n("div",{staticClass:"tabTask-menu__dropItem clearfix",on:{click:function(t){i.handleTask(t,"click",e)}}},[n("div",{staticClass:"tabTask-menu__title"},[i._v(i._s(i.process[e].title))]),i._v(" "),n("div",{staticClass:"tabTask-menu__util"},[!1!==i.process[e].closable?n("i",{staticClass:"dmw-icon icon-close f12",on:{click:function(t){i.handleTask(t,"remove",e)}}}):i._e(),i._v(" "),!1!==i.process[e].refreshable?n("i",{staticClass:"dmw-icon icon-refresh f12",on:{click:function(t){i.handleTask(t,"refresh",e)}}}):i._e()])])])})],2)])],1)],2)])])};h._withStripped=!0;var f,p,m,w,y,g=(m=void 0,w=!(f={render:h,staticRenderFns:[]}),(y=("function"==typeof(p=u)?p.options:p)||{}).__file="/Users/sicmouse/Documents/GitHub/ddv-multi-window/src/components/task.vue",y.render||(y.render=f.render,y.staticRenderFns=f.staticRenderFns,y._compiled=!0,w&&(y.functional=!0)),y._scopeId=m,y),k={name:"ddv-multi-window-load",render:function(t){return t("section",[t("div",{},["\u52a0\u8f7d\u4e2d..."])])}};function W(t){if(Array.isArray(t))return t.map(W);if(t&&"object"==typeof t){var e={};for(var i in t)e[i]=W(t[i]);return e}return t}function b(t,e){return function e(i,n){Object.keys(n||{}).forEach(function(t){"object"==typeof i[t]?i[t]=e(i[t],n[t]):i[t]=d(i[t],n[t])});return i}(W(e),W(t))}var $=k;var I={data:function(){return{dragData:{id:null},process:{}}},computed:{ready:function(){return this.process.daemon.init},pids:function(){return Object.keys(this.process||{})||[]},taskIds:function(){var e=this;return this.pids.filter(function(t){return e.process[t]&&e.process[t].isTask})},viewIds:function(){var e=this;return this.pids.filter(function(t){return e.process[t]&&e.process[t].isHasView})},dragProcess:function(){return this.dragId&&this.process[this.dragId]||null}},created:function(){this.processPut({id:"daemon",mode:"daemon",isTask:!0,isHasView:!1,hasContentWindow:!0,contentWindow:this.$ddvMultiWindowGlobal.contentWindow}),this.$ddvMultiWindowGlobal.daemonInit(this),this.process.daemon.init=!0}};function _(e){return new Promise(function(t){return setTimeout(t,e)})}function M(t,e,i,n){if(this instanceof M)return M(t,e,i);var r=new Error(t||"Unknown Error");return r.name=e||i||r.name,r.errorId=i||r.name,n&&(r.stack=r.stack+"\n"+n),r}function T(t,e,i,n,r){if(!1===i)throw M(t,e,n,r);return Promise.reject(M(t,e,n,r))}function C(e,i,n,r){return(n=n||50)<r?(console.error(e,i),Promise.reject(new Error("\u67e5\u627e\u5931\u8d25"))):(r=(r||0)+1,e[i]?Promise.resolve(e[i]):_(60).then(function(t){return C(e,i,n,r)}))}var P=require("jquery"),D={methods:{regTask:function(t){var e=this.process[t];if(!e)throw new Error("\u6ca1\u6709\u627e\u5230\u4efb\u52a1\u680f\u7a97\u53e3");e.isTask&&Array.isArray(e.pids)||(this.$set(e,"isTask",!0),this.$set(e,"pids",[]),this.$set(e,"history",[]),this.$set(e,"activeId",null))},addTask:function(t){var e=t.taskId,i=t.id,n=this.process[e].pids;-1<n.indexOf(i)||n.push(i)},refreshTask:function(t){var i=this,n=t.taskId,r=t.id;(this.taskIds||[]).forEach(function(t){var e=i.process[t];e&&t!==n&&(e.pids=e.pids.filter(function(t){return t!==r}),e.history=e.history.filter(function(t){return t!==r}))})},windowAppendChild:function(t,e){var i,n,r=this,o=t.id,s=t.taskId,a=t.autoToTab;return 50<e?Promise.reject(new Error("\u67e5\u627e\u5931\u8d25")):(e=(e||0)+1,o&&(i=this.process[o])?i.removeing?Promise.resolve():i.$mainWrap&&i.$mainWrap[s]?(i.$mainWrap[s].append(i.$content),n=i.taskId,i.taskId=s,!1===a?Promise.resolve():this.tabToWindow(o).then(function(){return r.refreshTask({taskId:s,id:o}),r.tabToLastWindowByTaskId(n||"daemon")})):_(350).then(function(){return r.windowAppendChild({id:o,taskId:s,autoToTab:a},e)}):Promise.resolve())},viewMoveParentByPid:function(t){var e=this.process[t];e&&e.$parent&&e.$parent.length&&e.$content&&e.$content.length&&e.$parent.append(e.$content)},closeMasterWindow:function(t,e){var i=this,n=this.process[t||"daemon"];if(n&&(this.masterMoveParentByTaskId(t),!1!==e)){if(!0===e||e<=0){var r=this.process.daemon,o=n.activeId;if("master"!==n.mode)return;(n.history||[]).forEach(function(t){-1<r.history.indexOf(t)||r.history.push(t)});var s=(n.pids||[]).map(function(t){return i.addTask({taskId:"daemon",id:t}),i.windowAppendChild({taskId:"daemon",id:t,autoToTab:!1})});return n.hasContentWindow&&n.contentWindow&&!n.contentWindow.closed&&n.contentWindow.close(),Promise.all(s).then(function(){return n.pids.length=0,i.refreshTask({taskId:"daemon",id:o})})}clearTimeout(n.closeMasterTimer),n.closeMasterTimer=setTimeout(function(){i.closeMasterWindow(t,0)},e||5e3)}},closeAllMasterWindow:function(){var e=this.$ddvMultiWindowGlobal&&this.$ddvMultiWindowGlobal.map&&this.$ddvMultiWindowGlobal.map[this.daemonId]&&this.$ddvMultiWindowGlobal.map[this.daemonId].api;this.taskIds.forEach(function(t){Object.keys(e).forEach(function(t){e&&e[t]&&"function"==typeof e[t].onDaemonClose&&e[t].onDaemonClose()})})},masterMoveParentByTaskId:function(t){var e=t&&this.process[t];e&&(e.$mainParent&&e.$mainContent&&e.$mainParent.append(e.$mainContent),e.$taskParent&&e.$taskContent&&e.$taskParent.append(e.$taskContent))},masterViewInit:function(t,e,i){var n,r=this,o=this.process[e];return"view"===t?n="$mainContent":"task"===t&&(n="$taskContent"),o?(clearTimeout(o.closeMasterTimer),o[n]?o[n].length?i&&P(i).length?(i.append(o[n]),Promise.resolve()):Promise.reject(M("\u8fdb\u7a0b\u4e0d\u5b58\u5728")):Promise.reject(M("\u4efb\u52a1\u680f\u4e2d\u6ca1\u6709\u627e\u5230\u6302\u8f7d\u70b9")):C(o,n).then(function(){return r.masterViewInit(t,e,i)})):Promise.reject(M("\u8fdb\u7a0b\u4e0d\u5b58\u5728"))}}},O=0,E=0;function R(t){var e;return E!==A()&&(E=A(),O=0),e=E.toString()+(++O).toString(),t||(e=parseInt(e,10).toString(36)),e}function A(){return parseInt((new Date).getTime()/1e3)}var j,S={methods:{tryRun:function(t){var i=this;return this._dmw$tryRun(t).catch(function(e){return i.errorHooks.length?Promise.all(i.errorHooks.map(function(t){return t&&t(e)})):Promise.reject(e)})},_dmw$tryRun:function(t){if("function"==typeof t)try{var e=t();return e&&e.then?e:Promise.resolve(e)}catch(t){return Promise.reject(t)}return Promise.resolve()},createPid:function(t){return(t.mode||"child")+R()},isHasId:function(t){return-1<this.pids.indexOf(t)},checkPid:function(t,e,i){var n=this,r=0!==e;return r&&e<i?T("Window does not exist","WINDOW_NOT_EXIST",r):(i=(i||0)+1,this.isHasId(t)?r?Promise.resolve():void 0:r?_(150).then(function(){return n.checkPid(t,e,i)}):T("Window does not exist","WINDOW_NOT_EXIST",r))},getPidByWindow:function(t,e,i){var n,r,o,s=this,a=0!==e;if(e=d(e,50),a&&e<i)return T("Find pid based on window","FIND_PID_FAIL_BY_CW",a);for(n in i=(i||0)+1,s.process)if((r=s.process[n]).hasContentWindow)if(!r.contentWindow||r.contentWindow.closed)o=!0;else if(r.contentWindow===t)return a?Promise.resolve(n):n;return a&&o?a?this.dmw$handleContentWindowLoad().then(function(){return _(150)}).then(function(){return s.getPidByWindow(t,e,i)}):T("Process contentWindow not has init or closed","PROCESS_CW_NOT_INIT_OR_CLOSED",a):T("window not found","WINDOW_NOT_FINT",a)},getWindowByPid:function(t,e,i){var n=this,r=0!==e;if(e=d(e,50),r&&e<i)return T("Find window  based on pid","FIND_CW_FAIL_BY_PID",r);if(i=(i||0)+1,!t)return T("must input pid","MUST_INPUT_PID",r);var o=this.process[t];return o?o.hasContentWindow?!o.contentWindow||o.contentWindow.closed?r?this.dmw$handleContentWindowLoad().then(function(){return _(150)}).then(function(){return n.getWindowByPid(t,e,i)}):T("Process contentWindow not has init or closed","PROCESS_CW_NOT_INIT_OR_CLOSED",r):r?Promise.resolve({contentWindow:o.contentWindow}):o.contentWindow:T("Process not has contentWindow","PROCESS_NOT_CW",r):T("Process data not found","PROCESS_NOT_FIND",r)},processPut:function(t){t.id=t.id||t.pid;this.$set(this.process,t.id,v(t,{mode:null,error:null,isTask:!1,isHasTask:!0,isHasView:!0,init:!1,refinit:!1}))},routerReady:function(){var i=this;return new Promise(function(t,e){return i.$router.onReady(t,e)})}}},N={props:{daemonId:{type:[Number,String],default:"daemon"},modeNotTasks:{type:Array,default:function(){return["daemon","master"]}},openMasterWindowSrc:{type:String,default:"/"},renderOptions:{type:Object,default:function(){return{root:{},daemon:{},views:{},mains:{},tasks:{},taskParent:{},taskBox:{},mainParent:{},mainBox:{style:{width:"100%",height:"100%"}},mainContent:{style:{width:"100%",height:"100%"}},viewParent:{},viewBox:{style:{width:"100%",height:"100%"}},viewLoad:{},viewError:{},viewComponent:{},viewIframe:{attrs:{frameborder:0,width:"100%",height:"100%",allowtransparency:!0}}}}}}};function x(t){if(t&&(j=t),t||"undefined"==typeof window||(j=window),!j)throw M("\u6ca1\u6709\u627e\u5230\u7a97\u53e3");return j}var L={methods:{tabToWindow:function(e){if(!this.isHasId(e))return Promise.reject(M("\u7a97\u53e3\u4e0d\u5b58\u5728"));var t=this.process[this.process[e].taskId||"daemon"];return t.activeId=e,c(t.history,function(t){return t===e}),t.history.unshift(e),Promise.resolve()},tabToLastWindowByTaskId:function(t){var e=this.process[t||"daemon"];return"daemon"===t||e.pids&&e.pids.length?e&&e.history[0]&&this.tabToWindow(e.history[0]):this.closeMasterWindow(t,0)||Promise.resolve()},tabMoveMasterWindow:function(t){var e=t.taskId,i=t.id;return this.regTask(e),this.addTask({taskId:e,id:i}),this.windowAppendChild({taskId:e,id:i})},openMasterWindow:function(t){try{var e=this.createPid({mode:"master"}),i=function(t,e,i){var n,r,o;if(!i){if("undefined"==typeof window||window.window!==window)throw M("window must input","WINDOW_MUST_INPUT");i=window}try{n=i.open(t,e.name||"",function(t){var e=[];for(var i in t)t.hasOwnProperty(i)&&e.push(i+"="+t[i]);return e.join(",")}((o=i,(r=(r=e)||{}).width=r.width||640,r.height=r.height||480,r.left=r.left||o.screenX+(o.outerWidth-r.width)/2,r.top=r.top||o.screenY+(o.outerHeight-r.height)/2.5,r)))}catch(t){}if(n)return n;throw M("open window fail","OPEN_WINDOW_FAIL")}(this.openMasterWindowSrc,{name:e},this.daemonWindow||this.contentWindow);return this.processPut({id:e,mode:"master",isTask:!0,isHasView:!1,hasContentWindow:!0,contentWindow:i}),this.tabMoveMasterWindow({id:t,taskId:e})}catch(t){return Promise.reject(t)}}}};var B=/[!'()*]/g,H=function(t){return"%"+t.charCodeAt(0).toString(16)},U=/%2C/g,V=function(t){return encodeURIComponent(t).replace(B,H).replace(U,",")};function G(n){var t=n?Object.keys(n).map(function(e){var t=n[e];if(void 0===t)return"";if(null===t)return V(e);if(Array.isArray(t)){var i=[];return t.forEach(function(t){void 0!==t&&(null===t?i.push(V(e)):i.push(V(e)+"="+V(t)))}),i.join("&")}return V(e)+"="+V(t)}).filter(function(t){return 0<t.length}).join("&"):null;return t?"?"+t:""}var Y={methods:{open:function(e,t){var i=this,n={src:"/",title:"New window",closable:!0,refreshable:!0,removeing:!1,contentWindow:null,$content:null,$iframe:null,$parent:null,$mainWrap:{},hook:{beforeRefresh:[]},component:null,parentDdvMultiWindow:null,id:null},r=Object.create(null);if("string"==typeof e)r.src=e,r.options={src:e};else if("object"==typeof e){if(e.id&&-1<this.pids.indexOf(e.id)&&this.process[e.id])return this.tabToWindow(e.id).then(function(){if(!0===e.refresh)return i.refresh(e.id)}).then(function(){return i.process[e.id]});if(!e.src&&e.path){var o=e.path;e.query&&(o+=G(e.query)),e.src=o}if(Object.keys(n).forEach(function(t){Object.hasOwnProperty.call(e,t)&&(r[t]=e[t]),r.options=e}),!r.src&&t.$process){var s=t.$process,a=s.route,d=a.path;e.query?d+=G(e.query):d+=G(a.query),r.src=d,!e.title&&s.title&&(r.title=s.title)}}if(r.src){var c=this.$router.getMatchedComponents(r.src);if(r.mode||(r.mode=c.length?"component":"iframe"),c.length){var u=this.$router.resolve(r.src),h=u.route,l=u.href;r.src=l,r.route=h}}else if("object"==typeof e){var f=this.$router.resolve(e),p=f.route,m=f.href;r.src=m,r.route=p}return r.taskId="object"==typeof e?e.taskId||t&&t.taskId:r.taskId||t&&t.taskId,r.mode=r.mode||"iframe",r.id||(r.id=this.createPid({mode:r.mode})),r.isHasTask=-1===this.modeNotTasks.indexOf(r.mode),r.hasContentWindow=void 0===r.hasContentWindow?-1<["iframe","daemon","master"].indexOf(r.mode):r.hasContentWindow,v(Object.assign(r,{daemonId:this.daemonId}),n),r.title=r.title||"\u65b0\u7a97\u53e3[id:"+r.id+"]",!r.isHasTask||this.process[r.taskId]&&this.process[r.taskId].isTask||(r.taskId="daemon"),r.isHasTask&&(this.regTask(r.taskId),this.addTask({taskId:r.taskId,id:r.id})),r.parentDdvMultiWindow=t||null,this.processPut(r),this.tabToWindow(r.id).then(function(){return i.process[r.id]})},remove:function(i){var n=this,t=this.process[i];return this.isHasId(i)?!1===t.closable?Promise.reject(new Error("this window cannot be closed")):(t.removeing=!0,this.viewMoveParentByPid(i),this.taskIds.forEach(function(t){var e=n.process[t];e&&(c(e.pids,function(t){return t===i}),c(e.history,function(t){return t===i}))}),this.$delete(this.process,i),this.tabToLastWindowByTaskId(t.taskId||"daemon")):Promise.reject(new Error("this window is not found"))},refresh:function(t){var e=this.process[t];if(!this.isHasId(t))return Promise.reject(new Error("this window is not found"));if(!1===e.refreshable)return Promise.reject(new Error("this window does not support refresh"));if("component"!==e.mode)return"iframe"===e.mode?this.getWindowByPid(t).then(function(t){t.contentWindow.location.reload(!0)}):Promise.reject(new Error("window does not support refresh"));if(e.component){if(Array.isArray(e.hook.beforeRefresh))for(var i=0;i<e.hook.beforeRefresh.length;i++){var n=e.hook.beforeRefresh[i];if(s(n))if(!1===n())return Promise.resolve()}e.component=null}}}},F=require("jquery");function q(e,i){return e.push(i),function(){var t=e.indexOf(i);-1<t&&e.splice(t,1)}}var X={methods:{loadComponent:function(t){var e=this,i=this.process[t];return i&&i.isHasView?"component"!==i.mode?T("\u4e0d\u652f\u6301\u52a0\u8f7d"):(i.error=null,this.routerReady().then(function(){return e.$router.getMatchedComponents(i.src)}).then(function(t){if(!t.length){var e=new Error("404");return e.statusCode=404,Promise.reject(e)}return Promise.all(t.map(function(t){return t()}))}).then(function(t){i.component=Object.create(t[0]),i.component._ddvMultiWindow=new Wt(e,i.taskId,i),i.component.router=e.loadComponentRouter(i,i.component)}).catch(function(t){console.log("e",t),i.error=t})):T("\u4e0d\u652f\u6301\u663e\u793a")},loadComponentRouter:function(t,e){var i=Object.create(null);return Object.assign(i,K,{daemonApp:this,$parentRouter:this.$router,process:t,options:this.$router.options}),i}}},K={resolve:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return this.$parentRouter.resolve.apply(this.$parentRouter,t)},init:function(t){t._route=this.process.route,this.$vm=t,this.history={},this.history.current=Object.assign({},this.process.route)},push:function(e,t,i){return this.$vm.$ddvMultiWindow?this.$vm.$ddvMultiWindow.open(e):this.daemonApp.$ddvMultiWindowGlobal.get(this.process.daemonId,this.process.taskId).then(function(t){return t.open(e)})},replace:function(t,e,i){this.history.current=this.resolve(t).route}},J={name:"ddv-multi-window-daemon",mixins:[I,D,L,S,N,Y,{methods:{dmw$iframeLoad:function(e,t){var i,n=this;return e&&(i=this.process[e])?"iframe"!==i.mode||i.removeing?Promise.resolve():Promise.resolve().then(function(){if(!i.$iframe)return C(n.$refs,"if_"+e).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,i.$iframe=F(t)})}).then(function(){if((t||!i.contentWindow||i.contentWindow.closed)&&(i.contentWindow=i.$iframe[0]&&i.$iframe[0].contentWindow||null,!i.contentWindow||i.contentWindow.closed))return _(500).then(function(t){return n.dmw$iframeLoad(e,!0)})}):Promise.resolve()},dmw$mainWrapInit:function(t){var i,n=this;return t&&(i=this.process[t])?i.removeing||!i.isHasView?Promise.resolve():Promise.all((this.taskIds||[]).map(function(e){if(i.$mainWrap||n.$set(i,"$mainWrap",{}),!i.$mainWrap[e])return C(n.$refs,"mc_"+e+"_p_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,i.$mainWrap[e]=F(t)})})):Promise.resolve()},dmw$viewInit:function(t){var e,i=this;return t&&(e=this.process[t])?e.removeing||!e.isHasView?Promise.resolve():e.refinit?this.dmw$mainWrapInit(t):Promise.resolve().then(function(){if(!e.$parent)return C(i.$refs,"vp_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$parent=F(t)})}).then(function(){if(!e.$content)return C(i.$refs,"vb_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$content=F(t)})}).then(function(){return i.dmw$mainWrapInit(t)}).then(function(){return e.refinit=!0,"iframe"===e.mode?(e.init=!0,i.dmw$iframeLoad(t)):"component"===e.mode?i.loadComponent(t).then(function(){e.init=!0}).catch(function(t){e.error=t}):void 0}).then(function(){e.init=!0}).then(function(){return i.windowAppendChild({id:t,taskId:e.taskId})}):Promise.resolve()},dmw$taskInit:function(t){var e,i=this;if(t&&(e=this.process[t])&&!e.refinit&&!e.removeing&&e.isTask)return Promise.resolve().then(function(){if(!e.$taskParent)return C(i.$refs,"tp_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$taskParent=F(t)})}).then(function(){if(!e.$taskContent)return C(i.$refs,"tb_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$taskContent=F(t)})}).then(function(){if(!e.$mainParent)return C(i.$refs,"mp_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$mainParent=F(t)})}).then(function(){if(!e.$mainContent)return C(i.$refs,"mb_"+t).then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.$mainContent=F(t)})}).then(function(){e.refinit=!0})},dmw$processInit:function(){var i=this,e=[];return this.pids.forEach(function(t){return e.push()}),Promise.all(this.pids.map(function(t){var e;return t&&(e=i.process[t])?e.isHasView?i.dmw$viewInit(t):e.isTask?i.dmw$taskInit(t):Promise.resolve():Promise.resolve()}))},dmw$ddvMultiWindowMapInit:function(){var e=this,i=this.$ddvMultiWindowGlobal.map[this.daemonId];return Promise.all(this.taskIds.map(function(t){i.api[t]||(i.api[t]=new Wt(i.app,t))}).concat(Object.keys(i.api||{}).map(function(t){-1<e.taskIds.indexOf(t)||e.$delete(i.api,t)})))},dmw$handleContentWindowLoad:function(){return Promise.all([this.dmw$handleMasterWindowLoad(),this.dmw$handleIframeLoad()])},dmw$handleMasterWindowLoad:function(){var i=this;return Promise.resolve(this.pids.map(function(t){if(!t||!i.process)return Promise.resolve();var e=i.process[t];return e&&e.hasContentWindow,Promise.resolve()}))},dmw$handleIframeLoad:function(t,e){var i=this;return this.tryRun(function(t){return _(300).then(function(t){return i.dmw$iframeLoad(e)})})},dmw$handlePidsChange:function(){var e=this;return this.tryRun(function(t){return Promise.all([e.dmw$processInit()])})},dmw$handleTaskIdsChange:function(){var e=this;return this.tryRun(function(t){return e.dmw$ddvMultiWindowMapInit()})},dmw$onbeforeunload:function(t){return t.returnValue="\u5173\u95ed\u4f1a\u5bfc\u81f4\u6240\u6709\u7a97\u53e3\u90fd\u5173\u95ed\uff0c\u60a8\u786e\u8ba4\u5173\u95ed","\u5173\u95ed\u4f1a\u5bfc\u81f4\u6240\u6709\u7a97\u53e3\u90fd\u5173\u95ed?"},dmw$handleCloseInit:function(){var t=this.$ddvMultiWindowGlobal.contentWindow;t.addEventListener("close",this.closeAllMasterWindow.bind(this)),t.addEventListener("unload",this.closeAllMasterWindow.bind(this)),t.addEventListener("beforeunload",this.dmw$onbeforeunload.bind(this))}},watch:{taskIds:{handler:"dmw$handleTaskIdsChange",deep:!0},pids:{handler:"dmw$handlePidsChange",deep:!0}},mounted:function(){this.dmw$handleCloseInit()}},{methods:{handleTask:function(t,e,i){var n=this;return this.$ddvMultiWindow.tryRun(function(){return n["handleTask$"+e](t,i)})},handleTask$click:function(t,e){return t.stopPropagation(),t.preventDefault(),this.$ddvMultiWindow.tabToWindow(e)},handleTask$refresh:function(t,e){return t.stopPropagation(),t.preventDefault(),this.$ddvMultiWindow.refresh(e)},handleTask$openMasterWindow:function(t,e){return t.stopPropagation(),t.preventDefault(),this.$ddvMultiWindow.openMasterWindow(e)},handleTask$remove:function(t,e){return t.stopPropagation(),t.preventDefault(),this.$ddvMultiWindow.remove(e)},handleTask$removeAll:function(t,e){var i=this;t.stopPropagation(),t.preventDefault();var n=[];return this.process[e].pids.forEach(function(t){return i.process[t]&&!1!==i.process[t].closable&&n.push(i.$ddvMultiWindow.remove(t))}),Promise.all(n)},handleTask$contextMenu:function(t,e){t.stopPropagation(),t.preventDefault(),console.log("\u53f3\u952e")}}},{methods:{onBeforeOpen:function(t){return q(this.beforeOpenHooks,t)},onOpened:function(t){return q(this.openedHooks,t)},onBeforeRemove:function(t){return q(this.beforeRemoveHooks,t)},onBeforeRefres:function(t){return q(this.beforeRefresHooks,t)},onRefreshed:function(t){return q(this.refreshedHooks,t)},onReady:function(i,n){var r=this;return this.readyCbs.push(i),n&&this.errorHooks.push(n),function(){var t=r.readyCbs.indexOf(i),e=r.errorHooks.indexOf(n);-1<t&&r.readyCbs.splice(t,1),-1<e&&r.errorHooks.splice(e,1)}},onError:function(t){return q(this.errorHooks,t)}},beforeCreate:function(){this.readyCbs=[],this.errorHooks=[],this.openedHooks=[],this.refreshedHooks=[],this.beforeOpenHooks=[],this.beforeRemoveHooks=[],this.beforeRefresHooks=[]}},X],render:function(t){if(this.ready){var e=this.$slots.default?Array.prototype.concat(this.$slots.default):[];return e.push(t("div",b(this.renderOptions.daemon,{key:"daemon_wrap",directives:[{name:"show",rawName:"show",value:!1}]}),[function(t){return t("div",b(this.renderOptions.mains,{key:"mains",attrs:{"ddv-multi-window-type":"mains"}}),function(n){var r=this;return this.taskIds.map(function(e){var i=r.process[e];if(i&&i.isTask)return n("div",b(r.renderOptions.mainParent,{key:e,ref:"mp_"+e,attrs:{"task-id":e,"ddv-multi-window-type":"mainParent"}}),[n("div",b(r.renderOptions.mainBox,{key:"main",ref:"mb_"+e,attrs:{"task-id":e,"ddv-multi-window-type":"mainBox"}}),(r.viewIds||[]).map(function(t){return n("div",b(r.renderOptions.mainContent,{key:t,ref:"mc_"+e+"_p_"+t,attrs:{"task-id":e,"process-id":t,"ddv-multi-window-type":"mainContent"},directives:[{name:"show",rawName:"show",value:i&&t===i.activeId}]}))}))])})}.call(this,t))}.call(this,t),function(t){return t("div",b(this.renderOptions.views,{key:"views",attrs:{"ddv-multi-window-type":"views"}}),function(n){var r=this;return this.viewIds.map(function(e){var i=r.process[e];if(i&&i.isHasView){var t=[];return i.init?i.error?t.push(n($,b(r.renderOptions.viewError,{key:"error",attrs:{"process-id":e,"ddv-multi-window-type":"errorBox"},props:{error:r.error}}))):"component"===i.mode?i.component?t.push(n(i.component,b(r.renderOptions.viewComponent,{props:{}}))):(i.init=!1,r.loadComponent(e).then(function(){i.init=!0}).catch(function(t){i.error=t})):"iframe"===i.mode&&t.push(n("iframe",b(r.renderOptions.viewIframe,{key:"iframe",ref:"if_"+e,on:{load:function(t){return r.dmw$handleIframeLoad(t,e)}},attrs:{src:i.src,"process-id":e,"ddv-multi-window-type":"iframe"}}))):t.push(n(k,b(r.renderOptions.viewLoad,{key:"load",attrs:{"process-id":e,"ddv-multi-window-type":"loadBox"}}))),n("div",b(r.renderOptions.viewParent,{key:e,ref:"vp_"+e,attrs:{"process-id":e,"ddv-multi-window-type":"viewParent"}}),[n("div",b(r.renderOptions.viewBox,{key:"view",ref:"vb_"+e,attrs:{"process-id":e,"ddv-multi-window-type":"viewBox"}}),t)])}})}.call(this,t))}.call(this,t),function(t){return t("div",b(this.renderOptions.tasks,{key:"tasks",attrs:{"ddv-multi-window-type":"tasks"}}),function(i){var n=this;return this.taskIds.map(function(t){var e=n.process[t];if(e&&e.isTask)return i("div",b(n.renderOptions.taskParent,{key:t,ref:"tp_"+t,attrs:{"process-id":t,"ddv-multi-window-type":"taskParent"}}),[i("div",b(n.renderOptions.taskBox,{key:"task",ref:"tb_"+t,attrs:{"process-id":t,"ddv-multi-window-type":"taskBox"}}),function(t,e){var i={task:e,process:this.process,handleTask:this.handleTask},n=[];return this.$scopedSlots&&this.$scopedSlots.task?n.push(this.$scopedSlots.task(i)):n.push(t(g,{key:"task",attrs:{"ddv-multi-window-type":"taskContent"},props:i})),n}.call(n,i,e))])})}.call(this,t))}.call(this,t)])),t("div",b(this.renderOptions.root,{key:"root",attrs:{id:"dmw_daemon_"+this.daemonId,"ddv-multi-window-type":"root"}}),e)}}},z={name:"ddv-multi-window-button",props:{to:{type:[String,Object]},type:{type:String,default:"open"},tag:{type:String,default:"button"},daemonId:{type:[Number,String],default:"daemon"},taskId:{type:[Number,String],default:""},event:{type:[String,Array],default:"click"},title:{type:String}},data:function(){return{ddvMultiWindowReady:!1,error:null}},render:function(t){var e=this,i={click:Q};return Array.isArray(this.event)?this.event.forEach(function(t){i[t]=e.handler.bind(e)}):i[this.event]=this.handler.bind(this),t(this.tag,{on:i},this.$slots.default)},methods:{masterInit:function(){var e=this;this.$ddvMultiWindowGlobal.masterInit(this).then(function(){e.ddvMultiWindowReady=!0},function(t){console.error(t),e.error=t})},handler:function(t){var e=this;if(Q(t)){var i=t.currentTarget.getAttribute("target")||this.taskId,n=b("string"==typeof this.to?{src:this.to}:W(this.to),{taskId:i});if(this.title&&(n.title=this.title),!this.ddvMultiWindowReady)return this.$ddvMultiWindowGlobal.masterInit(this).then(function(){e.comply(n)});this.comply(n)}},comply:function(t){var e=this;this.$ddvMultiWindow.tryRun(function(){switch(e.type){case"open":return e.$ddvMultiWindow.open(t);case"close":case"remove":return e.$ddvMultiWindow.remove(e.$router.process.id);default:return Promise.reject(new Error("this operation is not supported yet"))}})}},created:function(){this.$isServer||this.masterInit()}};function Q(t){if(!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey||t.defaultPrevented))return t.preventDefault&&t.preventDefault(),!0}var Z={name:"ddv-multi-window-error",props:{view:{type:String,default:"view"},error:{}},render:function(t){return t("section",[t("div",{},[this.message])])},computed:{message:function(){return this.error.message||"\u51fa\u9519\u4e86"}}},tt=require("jquery"),et=it();function it(t,e){return{name:t||"ddv-multi-window-master",props:{daemonId:{type:[Number,String],default:"daemon"},view:{type:String,default:e||"view"},autoColse:{type:Boolean,default:!0}},data:function(){return{ddvMultiWindowReady:!1,refReady:!1,error:null,init:!1,wrap:null,$wrap:null}},render:function(t){var e=[];return this.error?e.push(t(Z,{key:"error",attrs:{"ddv-multi-window-type":"errorBox"},props:{view:this.view,error:this.error}})):this.init||e.push(t(k,{key:"load"})),t("div",{key:"master",ref:"m",attrs:{id:"dmw_master_"+this.view+this.daemonId,"ddv-multi-window-type":"master"+this.view}},e)},methods:{masterInit:function(){var e=this;this.$ddvMultiWindowGlobal.masterInit(this).then(function(){e.$ddvMultiWindow.onDaemonClose=e.onDaemonClose.bind(e),e.ddvMultiWindowReady=!0},function(t){console.error(t),e.error=t})},refReadyInit:function(){var e=this;return Promise.resolve().then(function(){if(!e.wrap)return C(e.$refs,"m").then(function(t){t=Array.isArray(t)?t[0]:t&&t[0]||t,e.wrap=t,e.$wrap=tt(e.wrap)})}).then(function(){e.refReady=!0})},closeWindow:function(){try{this.contentWindow.close()}catch(t){try{window.close()}catch(t){}}},closeMasterWindow:function(){try{this.$ddvMultiWindow.closeMasterWindow(this.taskId,5e3)}catch(t){this.closeWindow()}},masterViewInit:function(){var t=this;if(this.masterReady){var e=this.contentWindow;e.addEventListener("close",this.closeMasterWindow.bind(this)),e.addEventListener("unload",this.closeMasterWindow.bind(this)),this.$ddvMultiWindow.masterViewInit(this.view,this.taskId,this.$wrap).then(function(){t.init=!0})}},onDaemonClose:function(){var t=this;this.$ddvMultiWindow.masterMoveParentByTaskId(this.taskId),this.error=new Error("\u4e3b\u7a97\u53e3\u88ab\u5173\u95ed"),this.autoColse&&setTimeout(function(){t.closeWindow()},1500)}},computed:{taskId:function(){return this.ddvMultiWindowReady?this.$ddvMultiWindow.taskId:null},contentWindow:function(){return this.$ddvMultiWindowGlobal.contentWindow},masterReady:function(){return this.refReady&&this.ddvMultiWindowReady}},watch:{masterReady:{handler:"masterViewInit"}},created:function(){this.$isServer||this.masterInit()},mounted:function(){this.$isServer||this.refReadyInit()}}}var nt={name:"dmw-button",functional:!0,render:function(t,e){var i=e.data,n=e.children,r=e.props;return i.props=r,t(z,i,n)}},rt=it("ddv-multi-window-task","task"),ot=it("ddv-multi-window-view","view");function st(t,e){return(t=t||this)&&t[e]?t[e]:t&&t.$parent?st(t.$parent,e):null}var at=ht.prototype=Object.create(null),dt=Object.hasOwnProperty,ct=Object.create(null),ut=new ht;function ht(){}Object.assign(ut,{get:function(t,e,i,n){var r=0!==i;if(!this.installed)return T("not installed. Make sure to call `Vue.use(DdvMultiWindow)`before creating root instance.","MUST_VUE_USE_DDV_MULTI_WINDOW",r);var o=this.map[t];if(!(o&&o.app&&o.api))return T("daemonId does not exist","DAEMONID_NOT_EXIST",r);if(e&&o.api[e])return r?Promise.resolve(o.api[e]):o.api[e];if("daemon"===e)return o.api.daemon=new lt(o.app,e),r?Promise.resolve(o.api.daemon):o.api.daemon;return e=o.api.daemon.getPidByWindow(this.contentWindow,i,n),r?e.then(function(t){return t&&!o.api[t]&&(o.api[t]=new lt(o.app,t)),Promise.resolve(o.api[t])}):(e&&!o.api[e]&&(o.api[e]=new lt(o.app,e)),o.api[e])},isDaemon:!0,version:"0.1.8",Ready:e,install:function(t,e){if((this.installing||this.installed)&&this.$Vue===t)return;if(this.installing=!0,this.$Vue=t,this.options=e,function(t){var e=t.config.optionMergeStrategies;e.beforeDdvMultiWindowOpen=e.ddvMultiWindowOpened=e.beforeDdvMultiWindowRemove=e.ddvMultiWindowRemoved=e.beforeDdvMultiWindowRefresh=e.ddvMultiWindowRefreshed=e.created}.call(this,t),function(t){t.component(g.name,g),t.component(J.name,J),t.component(z.name,z),t.component(et.name,et),t.component(nt.name,nt),t.component(rt.name,rt),t.component(ot.name,ot)}.call(this,t),function(t){var e=this;dt(t.prototype,"$ddvMultiWindow")||Object.defineProperty(t.prototype,"$ddvMultiWindow",{get:function(){if(this._ddvMultiWindow||(this._ddvMultiWindow=st(this,"_ddvMultiWindow")),this._ddvMultiWindow)return this._ddvMultiWindow;throw M("Not initialized")}}),dt(t.prototype,"$ddvMultiWindowGlobal")||Object.defineProperty(t.prototype,"$ddvMultiWindowGlobal",{get:function(){return e}})}.call(this,t),function(t){t.mixin({beforeCreate:function(){this._ddvMultiWindow||(this._ddvMultiWindow=this.$options._ddvMultiWindow||st(this.$parent,"_ddvMultiWindow")),this._ddvMultiWindow&&this._ddvMultiWindow.register(this)},destroyed:function(){this._ddvMultiWindow&&this._ddvMultiWindow.unregister&&(this._ddvMultiWindow.unregister(this),delete this._ddvMultiWindow)}})}.call(this,t),t.prototype.$isServer)return this.installing=!1,void(this.installed=!0);(function(){this.options=v(this.options||{},{namespace:"__DDV_MULTI_WINDOW__"})}).call(this),function(){this.options.window||(this.options.window=void 0===typeof window?this.options.window:window);this.contentWindow=x(this.options.window),this.daemonWindow=function t(e){var i,n;e=x(e);try{i=e.location.host}catch(t){}if(!n||n===e)try{if(e.parent&&e.parent.location&&i===e.parent.location.host)try{e.parent.$ddvUtil&&e.parent.$ddvUtil.$daemonWindow&&e.parent.$ddvUtil.$daemonWindow.location&&i===e.parent.$ddvUtil.$daemonWindow.location.host&&(n=e.parent.$ddvUtil.$daemonWindow)}catch(t){}}catch(t){}if(!n||n===e)try{if(e.top&&e.top.location&&i===e.top.location.host){try{e.top.$ddvUtil&&e.top.$ddvUtil.$daemonWindow&&e.top.$ddvUtil.$daemonWindow.location&&i===e.top.$ddvUtil.$daemonWindow.location.host&&(n=e.top.$ddvUtil.$daemonWindow)}catch(t){}if(!n){n=e.top;try{e.top.opener&&e.top.opener.location&&i===e.top.opener.location.host&&(n=e.top.opener)}catch(t){}}}}catch(t){}if(!n||n===e)try{if(e.parent&&e.parent.location&&i===e.parent.location.host){n=e.parent;try{e.parent.opener&&e.parent.opener.location&&i===e.parent.opener.location.host&&(n=e.parent.opener)}catch(t){}}}catch(t){}if(!n||n===e)try{if(e.opener&&e.opener.location&&i===e.opener.location.host){try{e.opener.$ddvUtil&&e.opener.$ddvUtil.$daemonWindow&&e.opener.$ddvUtil.$daemonWindow.location&&i===e.opener.$ddvUtil.$daemonWindow.location.host&&(n=e.opener.$ddvUtil.$daemonWindow)}catch(t){}if(!n){n=e.opener;try{e.opener.opener&&e.opener.opener.location&&i===e.opener.opener.location.host&&(n=e.opener.opener)}catch(t){}}}}catch(t){}return n&&n!==e&&(n=t(n)),n||(n=e),n}(this.contentWindow),this.isDaemon=!this.contentWindow||this.contentWindow===this.daemonWindow;try{this.contentWindow&&(this.contentWindow.$ddvUtil||(this.contentWindow.$ddvUtil={}),this.contentWindow.$ddvUtil.$daemonWindow=this.daemonWindow)}catch(t){}}.call(this),function(t){t=t||this.options.namespace,this.contentWindow[t]||(this.contentWindow[t]=this)}.call(this),function(){if(this.map)return;this.contentWindow===this.daemonWindow?this.map=Object.create(null):this.daemonWindow&&this.daemonWindow[this.namespace]&&(this.map=this.daemonWindow[this.namespace].map||this.map);if(!this.map)throw M("Initialization failed, check if the 'options.namespace' is consistent with the daemon window")}.call(this),this.installing=!1,this.installed=!0},installed:!1,daemonInit:function(t){if(this.$isServer)return;var e=t.daemonId;if(!e)return T("not installed. Make sure to call `daemonInit(app)`before creating root instance.","DAEMON_NOT_INIT",!1);this.map[e]||(this.map[e]={app:t,api:{}});return t._ddvMultiWindow=this.get(e,"daemon",0)},masterInit:function(i){var e=this;if(this.$isServer)return;if(!this.installed)throw M("not installed. Make sure to call `Vue.use(DdvMultiWindow)`before creating root instance.");if(!i)throw M("\u5fc5\u987b\u4f20\u5165app\u5b9e\u4f8b");var t=i.daemonId;return this.get(t).then(function(t){try{e.contentWindow&&t&&(e.contentWindow.name=t.taskId)}catch(t){}return i._ddvMultiWindow=t},function(t){var e;return"DAEMONID_NOT_EXIST"===t.name&&(e=st(i,"_ddvMultiWindow"))?e:Promise.reject(t)})}}),Object.assign(ct,{$isServer:function(){return this.$Vue?this.$Vue.prototype.$isServer:null},$Vue:[function(){return this._Vue?this._Vue:null},function(t){return this._Vue=t}],namespace:[function(){return this.options&&this.options.namespace},function(t){return this.options=this.options||Object.create(null),this.options.namespace=t}]}),Object.keys(ct).forEach(function(t){if(!dt.call(ht.prototype,t)){var e=ct[t];if(s(e))Object.defineProperty(at,t,{get:e});else if(Array.isArray(e)){var i={};o(e[0])&&s(e[0])&&(i.get=e[0]),o(e[1])&&s(e[1])&&(i.set=e[1]),Object.defineProperty(at,t,i)}}});var lt,ft=ut.install,pt=Wt.prototype=Object.create(null),mt=Object.hasOwnProperty,vt=Object.create(null),wt="proxyDaemonApp";function yt(t){return this.daemonApp.remove(t||this.id)}function gt(){var t=this;return this.back().then(function(){return t.remove()})}function kt(){var t=this;return this.backRefresh().then(function(){return t.remove()})}function Wt(){if(this instanceof Wt)return this.constructor.apply(this,arguments);throw Error("Must `new DdvMultiWindow()`")}function bt(t){return this instanceof bt?function(t){if(this.eventName=t.eventName||"ddvTabSysEventMessage",this.postMessageType=t.postMessageType||this.eventName+"#",this.targetOrigin=t.targetOrigin||"*",this.selfWindow=t.selfWindow||this.selfWindow,this.postEmitCallCbs={},!this.selfWindow){if("object"!=typeof window||window!==window.window)throw M("options.selfWindow must input","OPTIONS_SELFWINDOW_MUST_INPUT");this.selfWindow=window}this.selfWindow=t.selfWindow||("object"==typeof window&&window===window.window?window:this.selfWindow),this.setGetContentWindow(t.getContentWindow),s(t.onCatch)&&(this.onCatch=t.onCatch);this.onReceives={},function(t){t.addEventListener?(t.addEventListener("message",Mt.bind(this),!1),t.addEventListener(this.eventName,Tt.bind(this),!1)):t.attachEvent&&(t.attachEvent("onmessage",Mt.bind(this)),t.attachEvent("on"+this.eventName,Tt.bind(this)));try{"object"!=typeof t.onDdvMultiWindowEMCall&&(t.onDdvMultiWindowEMCall=Object.create(null)),t.onDdvMultiWindowEMCall[this.eventName]=function(t){try{this.receive(t)}catch(t){return!1}return!0}.bind(this)}catch(t){}return Promise.resolve()}.call(this,this.selfWindow),function(){this.on("postEmitCallCb",function(t){var e,i=t.data.id,n=t.data.res,r=t.data.error;r&&(r.message||r.stack)?(r.stack&&(e="@postEmitCallCb ------postEmitCallCb------\n"+r.stack),$t.call(this,i,void 0,M(r.message,r.name,r.errorId,e))):$t.call(this,i,n)}.bind(this))}.call(this)}.call(this,t):new bt(t)}function $t(t,e,i){this.postEmitCallCbs[t]?(i?this.postEmitCallCbs[t][1](i):this.postEmitCallCbs[t][0](e),delete this.postEmitCallCbs[t]):console.debug("\u4e0d\u5b58\u5728")}function It(t,e,i,n,r,o){var s,a,d,c,u,h,l;if("object"!=typeof i)return l=arguments,a=Array.prototype.slice.call(l),t=e=s=n=r=o=void 0,this.getContentWindow(i).then(function(t){return a[2]=t,t=a,a=void 0,It.apply(this,t)}.bind(this));s=i,r=r||R();var f=JSON.stringify({id:r,type:t,data:e,isCb:o||!1});try{c=s.postMessage||void 0,h=s.targetOrigin||void 0,(u=s.contentWindow||s)&&"function"==typeof u.postMessage&&s.isPostMessage&&(c=u.postMessage.bind(u)),d="function"==typeof c}catch(t){u=s}if(h||(h=this.targetOrigin||"*"),d)try{return c(this.postMessageType+f,h,n),Promise.resolve(r)}catch(t){}if(function(t,e){var i;try{if("object"==typeof t.onDdvMultiWindowEMCall&&"function"==typeof t.onDdvMultiWindowEMCall[this.eventName])return i=this.getMessageEvent(this.eventName,{data:e}),t.onDdvMultiWindowEMCall[this.eventName](i)&&!0}catch(t){}}.call(this,u,f))return Promise.resolve(r);if(function(t,e){var i;try{i=this.getMessageEvent(this.eventName,{data:e});try{if("function"==typeof t.dispatchEvent)return t.dispatchEvent(i),!0}catch(t){}try{if("function"==typeof t.fireEvent)return t.fireEvent("on"+this.eventName,i),!0}catch(t){}}catch(t){}return!1}.call(this,u,f))return Promise.resolve(r);try{if(u&&u.postMessage&&u.postMessage!==c)return u.postMessage(this.postMessageType+f,h,n),Promise.resolve(r)}catch(t){return Promise.reject(t)}return Promise.reject(M("postMessage fail","POST_MESSAGE_FAIL"))}function _t(n){return new Promise(function(t,e){var i=n(this.event);s(i.then)?(this.isCb=!0,i.then(t,e)):i?(this.isCb=!0,t(i)):t(),t=e=void 0}.bind(this)).then(function(t){return this.isCb&&this.event&&this.event.id&&this.postEmit("postEmitCallCb",{id:this.event.id,res:t},{contentWindow:this.event.source})}.bind(this),function(t){return this.isCb&&this.event&&this.event.id&&this.postEmit("postEmitCallCb",{id:this.event.id,error:{name:t.name||void 0,stack:t.stack||void 0,message:t.message||void 0,errorId:t.errorId||void 0}},{contentWindow:this.event.source})}.bind(this))}function Mt(t){var e=t.data||void 0;if("string"==typeof e&&e.substr(0,this.postMessageType.length)===this.postMessageType)return this.receive(t,e.substr(this.postMessageType.length))}function Tt(t){return this.receive(t)}lt=Wt,Object.assign(pt,{constructor:function(t,e,i){n(ut.installed,"not installed. Make sure to call `Vue.use(DdvMultiWindow)` before creating root instance."),n(r,"\u5fc5\u987b\u6709\u4e00\u4e2awindow"),this._vueModels=[],this._daemonApp=t,this._initTaskId=e,this._process=i||null},register:function(t){Array.isArray(this._vueModels)&&this._vueModels.push(t),this.process&&t&&t.$options.beforeDdvMultiWindowRefresh&&t.$options.beforeDdvMultiWindowRefresh.length&&this.process.hook.beforeRefresh.push.apply(this.process.hook.beforeRefresh,t.$options.beforeDdvMultiWindowRefresh)},unregister:function(e){this.process&&this.process.hook&&e&&e.$options&&e.$options.beforeDdvMultiWindowRefresh&&(this.process.hook.beforeRefresh=this.process.hook.beforeRefresh.filter(function(t){return e.$options.beforeDdvMultiWindowRefresh.indexOf(t)<0}));Array.isArray(this._vueModels)&&(this._vueModels=this._vueModels.filter(function(t){return e!==t}),this._vueModels.length||this.destroy())},open:function(t){return this.daemonApp.open(t,this)},remove:yt,refresh:function(t){return this.daemonApp.refresh(t||this.id)},close:yt,destroy:function(){delete this._vueModels,delete this._daemonApp,delete this._initTaskId,delete this._process},back:function(){return this.parent&&this.tabToWindow(this.parent.id)},backRefresh:function(){var t=this;return this.back().then(function(){return t.refresh(t.parent.id)})},removeBack:gt,removeBackRefresh:kt,closeBack:gt,closeBackRefresh:kt}),Object.assign(vt,{tryRun:wt,onError:wt,dragData:wt,dragProcess:wt,masterViewInit:wt,tabToWindow:wt,getPidByWindow:wt,getWindowByPid:wt,openMasterWindow:wt,windowAppendChild:wt,tabMoveMasterWindow:wt,closeMasterWindow:wt,masterMoveParentByTaskId:wt,systemProcess:function(){return this.daemonApp.process},process:function(){return this._process?this._process:null},id:function(){return this.process?this.process.id:null},parent:function(){return this.process&&this.process.parentDdvMultiWindow?this.process.parentDdvMultiWindow:null},taskId:function(){return this.process?this.process.taskId:this._initTaskId?this._initTaskId:null},daemonId:wt,daemonApp:function(){return this._daemonApp?this._daemonApp:null}}),Object.keys(vt).forEach(function(e){if(!mt.call(pt,e)){var t=vt[e];if(t===wt)Object.defineProperty(pt,e,{get:function(){return this.daemonApp,n(this.daemonApp,"\u591a\u7a97\u53e3\u6ca1\u6709\u521d\u59cb\u5316"),this.daemonApp[e]},set:function(t){return this.daemonApp,n(this.daemonApp,"\u591a\u7a97\u53e3\u6ca1\u6709\u521d\u59cb\u5316"),this.daemonApp[e]=t}});else if(s(t))Object.defineProperty(pt,e,{get:t});else if(Array.isArray(t)){var i={};o(t[0])&&s(t[0])&&(i.get=t[0]),o(t[1])&&s(t[1])&&(i.set=t[1]),Object.defineProperty(pt,e,i)}}}),Object.assign(bt.prototype,{eventName:"ddvTabSysEventMessage",targetOrigin:"*"},{on:function(t,e){Array.isArray(this.onReceives[t])||(this.onReceives[t]=[]);this.onReceives[t].push(e)},emit:function(t){var e;if(!t.type)return(e=M("Message type error","MESSAGE_TYPE_ERROR")).isDecodeError=!0,Promise.reject(e);for(var i=this.onReceives[t.type]||[],n=0;n<i.length;n++)_t.call({isCb:!1,event:t,postEmit:It.bind(this)},i[n]);t=void 0},remove:function(t,e){var i=this;if("function"==typeof t)for(var n in e=t,i.onReceives)i.onReceives.hasOwnProperty(n)&&i.remove(n,e);else if("string"==typeof t)if("function"==typeof e)for(var r=0;r<this.onReceives[t].length;r++)Array.isArray(i.onReceives[t])&&i.onReceives[t][r]===e&&(i.onReceives[t].splice(r,1),r--);else delete this.onReceives[t]},destroy:function(){},onCatch:function(t){return Promise.reject(t)},receive:function(i,t){return this.decodeMessage(t||i.data||void 0).then(function(t){var e=this.getMessageEvent(t.type,Object.assign(Object.create(null),{source:i.source,origin:i.origin},t));return this.emit(e)}.bind(this),function(t){return t.isDecodeError=!0,this.onCatch(t)}.bind(this))},postEmit:It,postEmitCall:function(t,r,o,s){return new Promise(function(e,i){var n=R();this.postEmitCallCbs[n]=[e,i],this.postEmit(t,r,o,s,n,!0).then(function(){n=e=i=void 0},function(t){$t.call(this,n,void 0,t),n=e=i=t=void 0}.bind(this))}.bind(this))},decodeMessage:function(t){var e;if("string"!=typeof t)return Promise.reject(M("Input must be a string","INPUT_MUST_STRING"));try{e=JSON.parse(t)}catch(t){return Promise.reject(M("window not found","WINDOW_NOT_FINT"))}return Promise.resolve(e)},getMessageEvent:function(t,e){var i;(e="object"==typeof e?e:Object.create(null)).source=e.source||this.selfWindow,e.origin=e.origin||this.selfWindow.origin||this.selfWindow.location&&this.selfWindow.location.origin;try{i="function"==typeof MessageEvent?new MessageEvent(t,e):new Event(t,e)}catch(t){i=e}return"source origin ports data id isCb".split(" ").forEach(function(t){try{e[t]&&i[t]!==e[t]&&(i[t]=e[t])}catch(t){}}),i},setGetContentWindow:function(t){s(t)?this.getContentWindow=t:this.getContentWindow=function(){return Promise.resolve({contentWindow:window})}}}),r&&window.Vue&&window.Vue.use(Wt),t.Ready=e,t.install=ft,t.default=ut,t.EventMessageWindow=bt,Object.defineProperty(t,"__esModule",{value:!0})});